<!doctype html>
<html lang="ur" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>دارالتعلیم والتربیہ - Darut Taleem Wat Tarbiyah</title>

  <!-- UPDATED FAVICON LINKS (with correct folder path) -->
  <link rel="apple-touch-icon" sizes="57x57" href="/favicon.ico/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/favicon.ico/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/favicon.ico/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/favicon.ico/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/favicon.ico/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/favicon.ico/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/favicon.ico/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/favicon.ico/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/favicon.ico/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/favicon.ico/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico/favicon-16x16.png">
  <link rel="manifest" href="/favicon.ico/manifest.json">
  <meta name="msapplication-TileColor" content="#007A3D">
  <meta name="msapplication-TileImage" content="/favicon.ico/ms-icon-144x144.png">
  <meta name="theme-color" content="#007A3D">
  <link rel="icon" href="/favicon.ico/favicon.ico">
  <meta name="msapplication-config" content="/favicon.ico/browserconfig.xml">

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Google Fonts: Poppins for English, Noto Nastaliq Urdu for fallback -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- UPDATED FONT LINK -->
  <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@400;700&family=Inter:wght@300;400;600&family=Lato:wght@300;400;700&family=Noto+Naskh+Arabic:wght@400;700&family=Noto+Nastaliq+Urdu:wght@400;700&family=Open+Sans:wght@300;400;600&family=Poppins:wght@300;400;600&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">


  <style>
    :root{
      --primary:#007A3D; /* green */
      --secondary:#F7C948; /* gold */
      --bg:#ffffff;
      --card-bg: #f8f9fa;
      /* Default fonts */
      --font-ur: 'Noto Nastaliq Urdu', serif;
      --font-en: 'Poppins', sans-serif;
    }
    
    /* Dynamic Font Loading */
    html[dir="rtl"] body{font-family: var(--font-ur), 'Noto Serif', serif;}
    html[dir="ltr"] body{font-family: var(--font-en), system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;}

    body{background:var(--bg); color:#222; transition: background-color 0.3s, color 0.3s;}
    .navbar{background:linear-gradient(90deg,var(--primary), rgba(0,122,61,.9));}
    .navbar .nav-link, .navbar-brand{color:#fff !important}
    .hero{background: linear-gradient( rgba(0,0,0,0.25), rgba(0,0,0,0.25) ), url('https://images.unsplash.com/photo-1523942839745-7844d3d58c73?q=80&w=1770&auto=format&fit=crop&ixlib=rb-4.0.3&s=') center/cover no-repeat; color:#fff; padding:80px 0}
    .accent{color:var(--primary)}
    .card-course{border:1px solid #eee}
    
    /* Announcement bar - updated for marquee */
    .announcement-bar {
      background: var(--primary);
      color: #fff;
      padding: .25rem 0;
      font-weight: 600;
      overflow: hidden;
      white-space: nowrap;
    }
    .announcement-text {
      display: inline-block;
      padding-left: 100%; /* Start off-screen */
      animation: marquee 30s linear infinite;
    }
    /* RTL marquee */
    [dir="rtl"] .announcement-text {
      animation-name: marquee-rtl;
      padding-right: 100%;
      padding-left: 0;
    }

    @keyframes marquee {
      0% { transform: translateX(0%); }
      100% { transform: translateX(-100%); }
    }
    @keyframes marquee-rtl {
      0% { transform: translateX(0%); }
      100% { transform: translateX(100%); }
    }
    
    .footer{background:#0b5132; color:#fff; padding:20px 0}

    /* Gallery grid - UPDATED to control max size */
    .gallery-grid{
        display:grid; 
        grid-template-columns: repeat(auto-fit,minmax(300px, 350px)); 
        gap:12px;
        /* Center the grid items if they don't fill the row */
        justify-content: center; 
    }
    .gallery-grid img{
      width:100%;  
      height: auto;
      aspect-ratio: 1 / 1; /* Makes it a perfect square */
      object-fit:cover;  
      border-radius:8px
    }

    /* Admin panel */
    .admin-panel{min-height:60vh}

    /* Responsive tweaks */
    @media(min-width:992px){ .hero{padding:100px 0} }

    /* RTL friendly card headings - ALIGNMENT FIX */
    [dir="rtl"] .section-title { text-align: right; }
    [dir="ltr"] .section-title { text-align: left; }


    /* Quick Links Grid */
    .quick-link-card {
      background-color: var(--card-bg);
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 1.5rem 1rem;
      text-align: center;
      transition: all 0.2s ease-in-out;
      text-decoration: none;
      color: #333;
      display: block;
      height: 100%;
    }
    .quick-link-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      color: var(--primary);
    }
    .quick-link-card svg {
      width: 40px;
      height: 40px;
      margin-bottom: 0.75rem;
      color: var(--primary);
    }
    .quick-link-card h5 {
      font-weight: 600;
      font-size: 1.1rem;
      margin: 0;
    }
    [dir="rtl"] .quick-link-card h5 {
      font-family: var(--font-ur), 'Noto Serif', serif;
      font-size: 1.4rem;
    }


    /* Dark Mode Styles */
    body.dark-mode {
      --bg: #121212;
      --card-bg: #1e1e1e;
      color: #e0e0e0;
    }
    body.dark-mode .card,
    body.dark-mode .modal-content,
    body.dark-mode .list-group-item {
      background-color: #1e1e1e;
      color: #e0e0e0;
      border-color: #333;
    }
    body.dark-mode .quick-link-card {
      color: #e0e0e0;
      border-color: #333;
    }
    body.dark-mode .list-group-item-action:hover {
      background-color: #282828;
    }
    body.dark-mode .list-group-item.active {
      background-color: var(--primary);
      border-color: var(--primary);
    }
    body.dark-mode .form-control {
      background-color: #222;
      color: #fff;
      border-color: #444;
    }
    body.dark-mode .form-control:focus {
      background-color: #222;
      color: #fff;
      border-color: var(--primary);
      box-shadow: 0 0 0 0.25rem rgba(0,122,61,.25);
    }
    /* Override Bootstrap's light text classes */
    body.dark-mode .text-dark {
      color: #e0e0e0 !important;
    }
    body.dark-mode .text-muted {
      color: #888 !important;
    }
    body.dark-mode .btn-light {
      background-color: #333;
      color: #fff;
      border-color: #444;
    }
    body.dark-mode .modal-header,
    body.dark-mode .modal-footer {
      border-color: #333;
    }
    body.dark-mode .btn-close {
      filter: invert(1);
    }
    
    #adminLogoPreview, #navbarLogo {
      height: 40px;
      width: auto;
      max-width: 150px;
      object-fit: contain;
      border-radius: 6px;
      background-color: rgba(255,255,255,0.1);
    }
    #navbarLogoContainer .fallback-logo {
        width:46px;  
        height:46px;  
        background:var(--secondary);  
        border-radius:8px;  
        display:grid;  
        place-items:center;  
        margin-inline-start:.6rem
    }
    
    /* Ensure brand title font switches properly */
    [dir="ltr"] #brandTitle { font-family: var(--font-en), sans-serif; }
    [dir="rtl"] #brandTitle { font-family: var(--font-ur), serif; }

    /* Library card dark mode fix */
    body.dark-mode #library .card,
    body.dark-mode #donationPaymentInfo {  
      background-color: #222;  
      border-color: #444;  
    }
    
    /* Contact info LTR fix */
    #contactInfo span[dir="ltr"] {
        display: inline-block;
    }

    /* Admin image previews */
    .admin-preview-img {
      max-width: 100px;
      height: auto;
      border-radius: 6px;
      margin-top: 10px;
    }

    /* Event Card */
    .event-card {
      background-color: var(--card-bg);
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 1.5rem;
      display: flex;
      gap: 1.5rem;
    }
    .event-card-date {
      flex-shrink: 0;
      background-color: var(--primary);
      color: #fff;
      border-radius: 8px;
      width: 70px;
      height: 70px;
      text-align: center;
      padding: 0.5rem;
    }
    .event-card-date .day {
      font-size: 1.75rem;
      font-weight: 700;
      display: block;
      line-height: 1.1;
    }
    .event-card-date .month {
      font-size: 0.9rem;
      display: block;
      text-transform: uppercase;
    }
    .event-card-body {
      flex-grow: 1;
    }
    .event-card-body h5 {
      font-weight: 700;
      font-size: 1.25rem;
    }
    [dir="rtl"] .event-card-body h5 {
      font-family: var(--font-ur), serif;
      font-size: 1.5rem;
    }

    /* Custom Section */
    .custom-section-img {
      width: 100%;
      height: auto;
      max-height: 400px;
      object-fit: cover;
      border-radius: 8px;
    }

  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="#">
        <!-- Logo container -->
        <div id="navbarLogoContainer" class="d-flex align-items-center">
          <div class="fallback-logo">
            <span style="font-weight:700; color:var(--primary)">د</span>
          </div>
        </div>
        <div class="ms-2">
          <!-- Added IDs for i18n -->
          <div id="brandTitle" style="font-size:18px; line-height:1">دارالتعلیم والتربیہ</div>
          <small id="brandSubtitle" style="opacity:.9; font-size:12px">Darut Taleem Wat Tarbiyah</small>
        </div>
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navLinks">
        <span class="navbar-toggler-icon" style="filter:invert(1)"></span>
      </button>

      <div class="collapse navbar-collapse" id="navLinks">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
          <!-- Added IDs for i18n -->
          <li class="nav-item"><a class="nav-link" href="#home" data-link id="navHome">صفحہ اول</a></li>
          <li class="nav-item"><a class="nav-link" href="#about" data-link id="navAbout">ہمارے بارے میں</a></li>
          <li class="nav-item"><a class="nav-link" href="#courses" data-link id="navCourses">کورسز</a></li>
          <li class="nav-item"><a class="nav-link" href="#events" data-link id="navEvents">پروگرام</a></li>
          <li class="nav-item"><a class="nav-link" href="#gallery" data-link id="navGallery">گیلری</a></li>
          <li class="nav-item"><a class="nav-link" href="#library" data-link id="navLibrary">کتب خانہ</a></li>
          <li class="nav-item"><a class="nav-link" href="#donation" data-link id="navDonation">عطیہ</a></li>
          <li class="nav-item"><a class="nav-link" href="#contact" data-link id="navContact">رابطہ کریں</a></li>
          <li class="nav-item"><a class="nav-link btn btn-sm btn-light text-dark ms-2" href="#admin" id="openAdmin">ایڈمن</a></li>
          <li class="nav-item d-flex align-items-center ms-2">
            <select id="langToggle" class="form-select form-select-sm" style="width:auto">
              <option value="ur" selected>اردو</option>
              <option value="en">English</option>
            </select>
          </li>
          <li class="nav-item d-flex align-items-center ms-2">
            <button id="darkModeToggle" class="btn btn-sm btn-outline-light" style="padding: 0.25rem 0.5rem; line-height: 1;">
              <!-- Moon icon -->
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-moon-fill" viewBox="0 0 16 16">
                <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.27 7.291 7.291 7.291.526 0 1.034-.063 1.518-.178.539-.111.558.611.082.858A.768.768 0 0 1 12.5 12.27a7.21 7.21 0 0 1-6.222-6.222.768.768 0 0 1 .278-.858z"/>
              </svg>
              <!-- Sun icon -->
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-sun-fill" viewBox="0 0 16 16" style="display:none;">
                <path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8M8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0m0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13m-5-4a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5M13 8a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5m-2.121 4.879a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707M4.879 4.879a.5.5 0 0 1-.707 0L2.757 3.464a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707m6.242 6.242a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707M4.879 11.121a.5.5 0 0 1-.707 0L2.757 9.707a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707"/>
              </svg>
            </button>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Announcement bar -->
  <div id="announcementBar" class="announcement-bar" role="region" aria-live="polite">
    <div class="announcement-text" id="announcementContent">Loading announcements...</div>
  </div>

  <!-- Hero -->
  <header id="home" class="hero text-center">
    <div class="container">
      <h1 id="heroTitle" class="display-5 fw-bold">...</h1>
      <p id="heroSubtitle" class="lead">...</p>
      <div class="mt-4">
        <a href="#courses" class="btn btn-outline-light btn-lg me-2" id="heroBtn1">...</a>
        <a href="#contact" class="btn btn-light btn-lg text-dark" id="heroBtn2">...</a>
      </div>
    </div>
  </header>

  <!-- Quick Links Section -->
  <section id="quick-links" class="py-5">
    <div class="container">
      <div class="row gy-4">
        <!-- Online Donation -->
        <div class="col-lg-3 col-md-4 col-6">
          <a href="#donation" class="quick-link-card" data-link>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-wallet-fill" viewBox="0 0 16 16"><path d="M1.5 2A1.5 1.5 0 0 0 0 3.5v2h6a.5.5 0 0 1 .5.5c0 .253.08.644.306.958.207.288.557.542 1.194.542s.987-.254 1.194-.542C9.42 6.644 9.5 6.253 9.5 6a.5.5 0 0 1 .5-.5h6v-2A1.5 1.5 0 0 0 14.5 2z"/><path d="M16 6.5h-5.551a2.678 2.678 0 0 1-.443 1.042C9.613 8.088 8.806 8.5 8 8.5s-1.613-.412-2.006-.958A2.679 2.679 0 0 1 5.551 6.5H0v6A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5z"/></svg>
            <h5 id="qLinkDonation">آن لائن عطیہ</h5>
          </a>
        </div>
        <!-- Online Fatwa -->
        <div class="col-lg-3 col-md-4 col-6">
          <a href="#contact" class="quick-link-card" data-link>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-patch-question-fill" viewBox="0 0 16 16"><path d="M5.933.87a2.89 2.89 0 0 1 4.134 0l.622.622a2.89 2.89 0 0 1 0 4.134l-.622.622a2.89 2.89 0 0 1-4.134 0l-.622-.622a2.89 2.89 0 0 1 0-4.134zM8 6a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 1 0v-1A.5.5 0 0 0 8 6m0 3a1 1 0 1 0 0 2 1 1 0 0 0 0-2"/>
            <path d="m10.273 2.513-.921-.921a1.89 1.89 0 0 0-2.672 0l-.921.921c.24.18.48.4.707.658.204.23.418.48.658.707.23-.204.48.418.707-.658.258-.226.48-.46.707-.707M11.39 8.243c.24.18.48.4.707.658.204.23.418.48.658.707.23-.204.48-.418.707-.658.258-.226.48-.46.707-.707l.921.921a1.89 1.89 0 0 1 0 2.672l-.921.921c-.24-.18-.48-.4-.707-.658a4.6 4.6 0 0 0-.658-.707c-.23.204-.48.418-.707.658-.258.226-.48.46-.707.707l-.921-.921a1.89 1.89 0 0 1 0-2.672l.921-.921zm-6.622 0-.921.921a1.89 1.89 0 0 0 0 2.672l.921.921c.24-.18.48-.4.707-.658.204-.23.418.48.658.707.23.204.48.418.707.658.258.226.48.46.707.707l.921-.921a1.89 1.89 0 0 0 0-2.672l-.921-.921c-.24.18-.48.4-.707.658a4.6 4.6 0 0 0-.658.707c-.23-.204-.48-.418-.707-.658-.258-.226-.48-.46-.707-.707M4.6 2.513c-.24.18-.48.4-.707.658a4.6 4.6 0 0 0-.658.707c-.23-.204-.48-.418-.707-.658-.258-.226-.48-.46-.707-.707l-.921.921a1.89 1.89 0 0 0 0 2.672l.921.921c.24-.18.48-.4.707-.658.204-.23.418.48.658.707.23.204.48.418.707.658.258.226.48.46.707.707l.921-.921a1.89 1.89 0 0 0 0-2.672l-.921-.921z"/></svg>
            <h5 id="qLinkFatwa">آن لائن فتویٰ</h5>
          </a>
        </div>
        <!-- Library -->
        <div class="col-lg-3 col-md-4 col-6">
          <a href="#library" class="quick-link-card" data-link>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-book-half" viewBox="0 0 16 16"><path d="M8.5 2.687c.654-.689 1.782-.886 3.112-.752 1.234.124 2.503.523 3.388 1.17.8-.5 1.6-1.12 2.6-1.55A.5.5 0 0 0 16 1.5v2.083c-1.004.456-2.005.972-3.006 1.577-1.344.803-2.677.803-4.02.0C7.68 4.62 6.35 4.14 5.07 3.657v-2.1a.5.5 0 0 1 .43-.49C6.4 1.006 7.3 1.06 8.5 2.687M8 3.5v10.868c-1.04-.43-2.115-.793-3.182-1.043C3.73 12.9 2.5 12.5 1.5 12.5c-.822 0-1.6.2-2.3.402v-9.6C.367 3.005.86 2.5 1.5 2.5c.822 0 1.6.2 2.3.402C4.867 3.207 5.93 3.5 7 3.5z"/><path d="M5.07 3.657v11.122C4.005 14.345 3.004 13.828 2.003 13.31c-.834-.41-1.63-.48-2.3-.41V2.98C.367 3.005.86 2.5 1.5 2.5c.822 0 1.6.2 2.3.402C4.867 3.207 5.93 3.5 7 3.5a6.97 6.97 0 0 1 1-.035V3.5z"/></svg>
            <h5 id="qLinkBooks">کتب خانہ</h5>
          </a>
        </div>
        <!-- Gallery -->
        <div class="col-lg-3 col-md-4 col-6">
          <a href="#gallery" class="quick-link-card" data-link>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-images" viewBox="0 0 16 16"><path d="M4.502 9a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3"/><path d="M14.002 13a2 2 0 0 1-2 2h-10a2 2 0 0 1-2-2V5A2 2 0 0 1 2 3a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v8a2 2 0 0 1-1.998 2M14 2H4a1 1 0 0 0-1 1h9.002a2 2 0 0 1 2 2v7A1 1 0 0 0 15 11V3a1 1 0 0 0-1-1M2.002 4a1 1 0 0 0-1 1v8l2.646-2.354a.5.5 0 0 1 .63-.062l2.66 1.773 3.71-3.71a.5.5 0 0 1 .577-.094l1.777 1.947V5a1 1 0 0 0-1-1z"/></svg>
            <h5 id="qLinkGallery">گیلری</h5>
          </a>
        </div>
      </div>
    </div>
  </section>

  <main class="py-5">
    <div class="container">

      <!-- About -->
      <section id="about" class="mb-5">
        <div class="section-title mb-3">
          <h2 id="aboutHeading">...</h2>
        </div>
        <div class="row gy-4 align-items-center">
          <div class="col-lg-6">
            <p id="aboutText">...</p>
          </div>
          <div class="col-lg-6">
            <img id="aboutImage" src="https://images.unsplash.com/photo-1542736667-069246bdbc6d?q=80&w=1600&auto=format&fit=crop&ixlib=rb-4.0.3&s=" alt="Madrasa" class="img-fluid rounded">
          </div>
        </div>
      </section>

      <!-- Courses -->
      <section id="courses" class="mb-5">
        <div class="section-title mb-3">
          <h2 id="coursesHeading">کورسز</h2>
        </div>
        <div id="coursesList" class="row gy-3">
          <!-- Course cards injected here -->
        </div>
      </section>

      <!-- Events -->
      <section id="events" class="mb-5">
        <div class="section-title mb-3">
          <h2 id="eventsHeading">پروگرام</h2>
        </div>
        <div id="eventsList" class="row gy-4">
          <!-- Event cards injected here -->
        </div>
      </section>

      <!-- Custom Sections Container -->
      <div id="customSectionsContainer">
        <!-- Custom sections injected here -->
      </div>

      <!-- Gallery -->
      <section id="gallery" class="mb-5">
        <div class="section-title mb-3">
          <h2 id="galleryHeading">گیلری</h2>
        </div>
        <div id="galleryGrid" class="gallery-grid">
          <!-- images injected here -->
        </div>
      </section>

      <!-- Library Section - Updated to be a link card -->
      <section id="library" class="mb-5">
        <div class="section-title mb-3">
          <h2 id="libraryHeading">کتب خانہ</h2>
        </div>
        <div class="card text-center p-4" style="background-color: var(--card-bg);">
          <div class="card-body">
            <h5 class="card-title" id="libraryCardTitle">Darul Uloom Deoband - Online Books</h5>
            <p class="card-text" id="libraryCardText">The requested library cannot be embedded directly on this page due to security restrictions. You can access the full library by clicking the button below.</p>
            <a href="http://darululoom-deoband.com/books/" id="libraryCardButton" class="btn btn-primary" target="_blank" rel="noopener noreferrer">Visit Library</a>
          </div>
        </div>
      </section>

      <!-- Donation Section -->
      <section id="donation" class="mb-5">
        <div class="section-title mb-3">
          <h2 id="donationHeading">عطیہ فارم</h2>
        </div>
        <div class="row">
          <div class="col-lg-8">
            <form id="donationForm">
              <div class="row">
                <!-- Donation Amount -->
                <div class="col-md-6 mb-3">
                  <label for="donationAmount" class="form-label" id="lblDonationAmount">Donation Amount (Indian Rupees)</label>
                  <input type="number" class="form-control" id="donationAmount" placeholder="Enter numeric value" required>
                </div>
                <!-- Donation Type -->
                <div class="col-md-6 mb-3">
                  <label for="donationType" class="form-label" id="lblDonationType">Donation Type</label>
                  <select class="form-select" id="donationType">
                    <option value="General" id="optDonationGeneral">General Donation</option>
                    <option value="Zakat" id="optDonationZakat">Zakat</option>
                    <option value="Sadqa" id="optDonationSadqa">Sadqa</option>
                    <option value="Construction" id="optDonationConstruction">Construction</option>
                    <option value="Other" id="optDonationOther">Other</option>
                  </select>
                </div>
                <!-- Other Donation Type (Hidden by default) -->
                <div class="col-md-12 mb-3" id="otherDonationTypeContainer" style="display: none;">
                  <label for="otherDonationType" class="form-label" id="lblOtherDonationType">Other Donation Type</label>
                  <input type="text" class="form-control" id="otherDonationType" placeholder="Specify, if other donation type">
                </div>
                <!-- Name -->
                <div class="col-md-6 mb-3">
                  <label for="donationName" class="form-label" id="lblDonationName">Name</label>
                  <input type="text" class="form-control" id="donationName" placeholder="Enter Full Name" required>
                </div>
                <!-- Phone -->
                <div class="col-md-6 mb-3">
                  <label for="donationPhone" class="form-label" id="lblDonationPhone">Mobile / Phone No.</label>
                  <input type="tel" class="form-control" id="donationPhone" placeholder="10 digits only" pattern="[0-9]{10}" required>
                </div>
                <!-- Address -->
                <div class="col-12 mb-3">
                  <label for="donationAddress" class="form-label" id="lblDonationAddress">Complete Address</label>
                  <textarea class="form-control" id="donationAddress" rows="3" placeholder="Including Pin within India" required></textarea>
                </div>
                <!-- Email -->
                <div class="col-md-6 mb-3">
                  <label for="donationEmail" class="form-label" id="lblDonationEmail">Email ID</label>
                  <input type="email" class="form-control" id="donationEmail" placeholder="Valid Email Address" required>
                </div>
                <!-- Document ID -->
                <div class="col-md-6 mb-3">
                  <label for="donationDocId" class="form-label" id="lblDonationDocId">Document ID (Aadhaar/PAN) No.</label>
                  <input type="text" class="form-control" id="donationDocId" placeholder="Valid Document No." required>
                </div>
              </div>
              <button class="btn btn-success btn-lg" type="submit" id="donationSubmit">Donate Now</button>
            </form>
          </div>
          <div class="col-lg-4">
            <!-- Payment Info Container -->
            <div id="donationPaymentInfo" class="text-center p-3 rounded" style="background-color: var(--card-bg); border: 1px solid #ddd; display: none;">
              <h5 id="donationPaymentTitle">Complete Your Donation</h5>
              <p id="donationPaymentSubtitle">Please support us by donating via UPI.</p>
              <img id="donationQR" src="" alt="UPI QR Code" class="img-fluid rounded mb-3" style="max-width: 200px;">
              <div class="input-group mb-3">
                <input type="text" id="upiIdInput" class="form-control" value="your-upi-id@ok" readonly>
                <button class="btn btn-outline-secondary" type="button" id="copyUpiButton">
                  <span id="copyUpiBtnText">Copy</span>
                </button>
              </div>
              <a id="payNowLink" href="#" class="btn btn-primary" target="_blank">
                <span id="payNowBtnText">Pay Now</span>
              </a>
            </div>
          </div>
        </div>
      </section>

      <!-- Contact -->
      <section id="contact" class="mb-5">
        <div class="section-title mb-3">
          <h2 id="contactHeading">رابطہ کریں</h2>
        </div>
        <div class="row">
          <div class="col-lg-6">
            <form id="contactForm">
              <div class="mb-3">
                <label class="form-label" id="lblName">نام</label>
                <input type="text" class="form-control" id="contactName" required>
              </div>
              <div class="mb-3">
                <label class="form-label" id="lblEmail">ای میل</label>
                <input type="email" class="form-control" id="contactEmail" required>
              </div>
              <div class="mb-3">
                <label class="form-label" id="lblSubject">موضوع</label>
                <input type="text" class="form-control" id="contactSubject">
              </div>
              <div class="mb-3">
                <label class="form-label" id="lblMessage">پیغام</label>
                <textarea class="form-control" id="contactMessage" rows="4" required></textarea>
              </div>
              <button class="btn btn-success" type="submit" id="contactSubmit">ارسال</button>
            </form>
            <!-- Note about email functionality -->
            <small class="d-block mt-3 text-muted" id="contactFormNote">Note: This is a demo. Messages are saved to your Firebase Admin Panel (Firestore) and are not sent via email.</small>
          </div>
          <!-- Updated Contact Info with LTR fixes -->
          <div class="col-lg-6">
            <h5 id="contactInfoHeading">رابطہ کی معلومات</h5>
            <p id="contactInfo" style="line-height: 1.8;">
              <strong id="lblAddress">پتہ:</strong> <span dir="ltr">H.no: 9, 4-134/5/A/1/1, Raghava Colony, Nadeem Colony, Vali Colony, Toli Chowki, Hyderabad, Telangana 500008</span><br>
              <strong id="lblPhone">فون:</strong> <span dir="ltr"><a href="tel:0905843885" class="text-dark" style="text-decoration:none;">090584 3885</a></span><br>
              <strong id="lblContactEmail">ای میل:</strong> <span dir="ltr"><a id="contactEmailLink" href="mailto:madrasadaruttaleemwattarbiyah@gmail.com" class="text-dark" style="text-decoration:none;">madrasadaruttaleemwattarbiyah@gmail.com</a></span><br>
              <strong id="lblMap">نقشہ:</strong> <a id="linkMap" href="https://maps.app.goo.gl/X85qiTVBdRNCRn8X7" target="_blank" rel="noopener noreferrer">گوگل میپس پر دیکھیں</a>
            </p>
          </div>
        </div>
      </section>

    </div>
  </main>

  <!-- Footer -->
  <footer class="footer text-center text-white">
    <div class="container">
      <div class="row">
        <div class="col-md-6 text-md-end">
          <p style="margin:0">© <span id="year"></span> دارالتعلیم والتربیہ</p>
        </div>
        <div class="col-md-6 text-md-start">
          <small>Follow us: <a href="#" class="text-white">Facebook</a> | <a href="#" class="text-white">Instagram</a></small>
        </div>
      </div>
    </div>
  </footer>

  <!-- Admin Modal / Panel (single-page simulated) -->
  <div class="modal fade" id="adminModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ایڈمن پینل</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">

          <!-- Login view -->
          <div id="adminLoginView">
            <form id="adminLoginForm">
              <div class="mb-3">
                <label id="lblAdminEmail">Email</label>
                <input class="form-control" id="adminUser" value="admin@madrasa.com">
              </div>
              <div class="mb-3">
                <label id="lblAdminPass">Password</label>
                <input class="form-control" id="adminPass" type="password" value="password">
              </div>
              <button class="btn btn-primary">Login</button>
            </form>
          </div>

          <!-- Panel view -->
          <div id="adminPanelView" style="display:none">
            <div class="row admin-panel">
              <div class="col-lg-3">
                <div class="list-group mb-3">
                  <button class="list-group-item list-group-item-action active" data-panel="ann">Announcements</button>
                  <button class="list-group-item list-group-item-action" data-panel="hero">Homepage (Hero)</button>
                  <button class="list-group-item list-group-item-action" data-panel="about">About Us</button>
                  <button class="list-group-item list-group-item-action" data-panel="courses">Courses</button>
                  <button class="list-group-item list-group-item-action" data-panel="events">Events</button>
                  <button class="list-group-item list-group-item-action" data-panel="customSections">Custom Sections</button>
                  <button class="list-group-item list-group-item-action" data-panel="gallery">Gallery</button>
                  <button class="list-group-item list-group-item-action" data-panel="logo">Logo</button>
                  <button class="list-group-item list-group-item-action" data-panel="donation">Donation Settings</button>
                  <button class="list-group-item list-group-item-action" data-panel="fonts">Font Settings</button>
                  <button class="list-group-item list-group-item-action" data-panel="messages">Messages</button>
                  <button class="list-group-item list-group-item-action" data-panel="donations" id="adminNavDonations">Donations</button>
                </div>

                <div>
                  <button id="adminLogout" class="btn btn-outline-danger btn-sm">Logout</button>
                </div>
              </div>

              <div class="col-lg-9">
                <div id="panelContent">
                  <!-- dynamic admin content injected here -->
                </div>
              </div>
            </div>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بند کریں</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Custom Toast Notification -->
  <div id="customToast" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
    <div class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div id="toastBody" class="toast-body">
          Message sent successfully.
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>


  <!-- Bootstrap + Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ADD FIREBASE SDKs (Modular) -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { 
      getFirestore, collection, getDocs, onSnapshot, doc, getDoc, 
      addDoc, setDoc, deleteDoc, updateDoc, query, where, orderBy 
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
    import { 
      getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut 
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyANp3lRfm2eruX3Y3M9_T5GIyfN6bRp0j8",
      authDomain: "madrasa-website-12926.firebaseapp.com",
      projectId: "madrasa-website-12926",
      storageBucket: "madrasa-website-12926.firebasestorage.app",
      messagingSenderId: "202677366743",
      appId: "1:202677366743:web:41109ec3d872be8472a592",
      measurementId: "G-N1Y5J2ELS4"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ----------------- i18n content -----------------
    const i18n = {
      ur: {
        brandTitle: 'دارالتعلیم والتربیہ',
        brandSubtitle: 'Darut Taleem Wat Tarbiyah',
        navHome: 'صفحہ اول',
        navAbout: 'ہمارے بارے میں',
        navCourses: 'کورسز',
        navEvents: 'پروگرام',
        navGallery: 'گیلری',
        navLibrary: 'کتب خانہ',
        navDonation: 'عطیہ',
        navContact: 'رابطہ کریں',
        navAdmin: 'ایڈمن',
        heroBtn1: 'مزید جانیں',
        heroBtn2: 'رابطہ کریں',
        qLinkDonation: 'آن لائن عطیہ',
        qLinkFatwa: 'آن لائن فتویٰ',
        qLinkBooks: 'کتب خانہ',
        qLinkGallery: 'گیلری',
        eventsHeading: 'پروگرام',
        coursesHeading: 'کورسز',
        galleryHeading: 'گیلری',
        contactHeading: 'رابطہ کریں',
        lblName: 'نام', lblEmail: 'ای میل', lblSubject: 'موضوع', lblMessage: 'پیغام', contactSubmit: 'ارسال', contactInfoHeading: 'رابطہ کی معلومات',
        lblAddress: 'پتہ:',
        lblPhone: 'فون:',
        lblContactEmail: 'ای میل:',
        lblMap: 'نقشہ:',
        linkMap: 'گوگل میپس پر دیکھیں',
        libraryHeading: 'کتب خانہ',
        libraryCardTitle: 'دارالعلوم دیوبند - آن لائن کتب',
        libraryCardText: 'درخواست کردہ کتب خانہ کو سیکورٹی پابندیوں کی وجہ سے براہ راست اس صفحہ پر نہیں دکھایا جا سکتا۔ آپ نیچے دیے گئے بٹن پر کلک کر کے مکمل کتب خانہ تک رسائی حاصل کر سکتے ہیں۔',
        libraryCardButton: 'کتب خانہ پر جائیں',
        contactFormNote: 'نوٹ: یہ ایک ڈیمو ہے۔ پیغامات کو ایڈمن پینل (فائربیس) میں محفوظ کیا جاتا ہے اور ای میل کے ذریعے نہیں بھیجا جاتا۔',
        donationHeading: 'عطیہ فارم',
        lblDonationAmount: 'رقمِ عطیہ (ہندوستانی روپیے)',
        lblDonationType: 'عطیہ کی قسم',
        optDonationGeneral: 'عام عطیہ',
        optDonationZakat: 'زکوٰۃ',
        optDonationSadqa: 'صدقہ',
        optDonationConstruction: 'تعمیر',
        optDonationOther: 'دیگر',
        lblOtherDonationType: 'دیگر عطیہ کی قسم',
        lblDonationName: 'نام',
        lblDonationPhone: 'موبائل / فون نمبر',
        lblDonationAddress: 'مکمل پتہ',
        lblDonationEmail: 'ای میل آئی ڈی',
        lblDonationDocId: 'دستاویز آئی ڈی (آدھار/پین) نمبر',
        donationSubmit: 'ابھی عطیہ دیں',
        donationPaymentTitle: 'اپنا عطیہ مکمل کریں۔',
        donationPaymentSubtitle: 'برائے مہربانی UPI کے ذریعے عطیہ دے کر ہماری مدد کریں۔',
        copyUpiBtnText: 'کاپی',
        payNowBtnText: 'ابھی ادا کریں۔',
        copiedToast: 'UPI ID کاپی ہو گیا!',
        adminLogo: 'لوگو',
        adminDonations: 'عطیات',
        adminHomepage: 'Homepage (Hero)',
        adminAbout: 'About Us',
        adminDonationSettings: 'Donation Settings',
        adminEvents: 'Events',
        adminCustomSections: 'Custom Sections',
        adminFontSettings: 'Font Settings',
        lblAdminEmail: 'ای میل',
        lblAdminPass: 'پاسورڈ',
      },
      en: {
        brandTitle: 'Darut Taleem Wat Tarbiyah',
        brandSubtitle: 'Knowledge and Upbringing',
        navHome: 'Home',
        navAbout: 'About Us',
        navCourses: 'Courses',
        navEvents: 'Events',
        navGallery: 'Gallery',
        navLibrary: 'Library',
        navDonation: 'Donation',
        navContact: 'Contact Us',
        navAdmin: 'Admin',
        heroBtn1: 'Learn More',
        heroBtn2: 'Contact Us',
        qLinkDonation: 'Online Donation',
        qLinkFatwa: 'Online Fatwa',
        qLinkBooks: 'Library',
        qLinkGallery: 'Gallery',
        eventsHeading: 'Events',
        coursesHeading: 'Courses',
        galleryHeading: 'Gallery',
        contactHeading: 'Contact Us',
        lblName: 'Name', lblEmail: 'Email', lblSubject: 'Subject', lblMessage: 'Message', contactSubmit: 'Send', contactInfoHeading: 'Contact Information',
        lblAddress: 'Address:',
        lblPhone: 'Phone:',
        lblContactEmail: 'Email:',
        lblMap: 'Map:',
        linkMap: 'View on Google Maps',
        libraryHeading: 'Library',
        libraryCardTitle: 'Darul Uloom Deoband - Online Books',
        libraryCardText: 'The requested library cannot be embedded directly on this page due to security restrictions. You can access the full library by clicking the button below.',
        libraryCardButton: 'Visit Library',
        contactFormNote: 'Note: This is a demo. Messages are saved to your Firebase Admin Panel (Firestore) and are not sent via email.',
        donationHeading: 'Donation Form',
        lblDonationAmount: 'Donation Amount (Indian Rupees)',
        lblDonationType: 'Donation Type',
        optDonationGeneral: 'General Donation',
        optDonationZakat: 'Zakat',
        optDonationSadqa: 'Sadqa',
        optDonationConstruction: 'Construction',
        optDonationOther: 'Other',
        lblOtherDonationType: 'Other Donation Type',
        lblDonationName: 'Name',
        lblDonationPhone: 'Mobile / Phone No.',
        lblDonationAddress: 'Complete Address',
        lblDonationEmail: 'Email ID',
        lblDonationDocId: 'Document ID (Aadhaar/PAN) No.',
        donationSubmit: 'Donate Now',
        donationPaymentTitle: 'Complete Your Donation',
        donationPaymentSubtitle: 'Please support us by donating via UPI.',
        copyUpiBtnText: 'Copy',
        payNowBtnText: 'Pay Now',
        copiedToast: 'UPI ID Copied!',
        adminLogo: 'Logo',
        adminDonations: 'Donations',
        adminHomepage: 'Homepage (Hero)',
        adminAbout: 'About Us',
        adminDonationSettings: 'Donation Settings',
        adminEvents: 'Events',
        adminCustomSections: 'Custom Sections',
        adminFontSettings: 'Font Settings',
        lblAdminEmail: 'Email',
        lblAdminPass: 'Password',
      }
    };
    
    // NEW: Font options
    const fontOptions = {
      ur: [
        { name: 'Jameel Noori Nastaleeq', value: "'Jameel Noori Nastaleeq', 'Noto Nastaliq Urdu', serif" },
        { name: 'Noto Nastaliq Urdu', value: "'Noto Nastaliq Urdu', serif" },
        { name: 'Noto Naskh Arabic', value: "'Noto Naskh Arabic', sans-serif" },
        { name: 'Almarai', value: "'Almarai', sans-serif" }
      ],
      en: [
        { name: 'Poppins', value: "'Poppins', sans-serif" },
        { name: 'Roboto', value: "'Roboto', sans-serif" },
        { name: 'Open Sans', value: "'Open Sans', sans-serif" },
        { name: 'Lato', value: "'Lato', sans-serif" },
        { name: 'Inter', value: "'Inter', sans-serif" }
      ]
    };

    // ----------------- Simple data store (Now in-memory) -----------------
    // We use this to hold dynamic config loaded from Firestore
    const siteData = {
      lang: 'ur',
      config: {
        heroTitleUr: "دارالتعلیم والتربیہ میں خوش آمدید",
        heroTitleEn: "Welcome to Darut Taleem Wat Tarbiyah",
        heroSubtitleUr: "تعلیم، تربیہ اور دین کی روشنی میں بہترین ماحول",
        heroSubtitleEn: "A nurturing place for knowledge & character",
        aboutTextUr: "دارالتعلیم والتربیہ ایک معروف مدرسہ ہے...",
        aboutTextEn: "Darut Taleem Wat Tarbiyah is a madrasa...",
        aboutImage: "https://images.unsplash.com/photo-1542736667-069246bdbc6d?q=80&w=1600&auto=format&fit=crop&ixlib=rb-4.0.3&s=",
        upiId: "your-upi-id@ok",
        fontUr: "'Jameel Noori Nastaleeq', 'Noto Nastaliq Urdu', serif",
        fontEn: "'Poppins', sans-serif"
      },
      logo: null
    };


    // ----------------- DOM helpers -----------------
    const setYear = ()=> document.getElementById('year').textContent = new Date().getFullYear()
    setYear()

    // ----------------- Toast Notification Helper -----------------
    const customToastEl = document.getElementById('customToast')
    const customToast = new bootstrap.Toast(customToastEl.querySelector('.toast'))
    const toastBody = document.getElementById('toastBody')
    const toastEl = customToastEl.querySelector('.toast')

    function showToast(message, type = 'success') {
        toastBody.textContent = message
        
        // Remove old classes, add new
        toastEl.classList.remove('bg-success', 'bg-danger')
        if (type === 'danger') {
            toastEl.classList.add('bg-danger')
        } else {
            toastEl.classList.add('bg-success')
        }
        
        customToast.show()
    }
    
    // ----------------- Base64 Image Resizer -----------------
    // Converts a file to a base64 string, with resizing
    function fileToResizedBase64(file, options = {}) {
      return new Promise((resolve, reject) => {
        const { maxWidth = 800, maxHeight = 800, quality = 0.8 } = options;
        
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            let width = img.width;
            let height = img.height;

            if (width > height) {
              if (width > maxWidth) {
                height = Math.round((height * maxWidth) / width);
                width = maxWidth;
              }
            } else {
              if (height > maxHeight) {
                width = Math.round((width * maxHeight) / height);
                height = maxHeight;
              }
            }

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            // Get the data URL
            const dataUrl = canvas.toDataURL(file.type, quality);
            
            // Check file size (Firestore limit is 1MiB)
            // 1,048,576 bytes. Base64 is ~33% larger, so limit to ~750KB.
            if (dataUrl.length > 1048576 * 0.75) {
              reject(new Error(`Image is too large after compression (size ${dataUrl.length} bytes). Please use a smaller image.`));
            } else {
              resolve(dataUrl);
            }
          };
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // ----------------- Render Dynamic Content -----------------

    // Render announcements in bar (Real-time)
    function renderAnnouncements(){
      const bar = document.getElementById('announcementContent');
      onSnapshot(collection(db, "announcements"), (snapshot) => {
        const anns = [];
        snapshot.forEach(doc => anns.push(doc.data()));
        
        if(anns.length === 0){ bar.textContent = '' ; return }
        const text = anns.map(a=>a.text).join('   •   ');
        bar.textContent = text + '   •   ' + text + '   •   ' + text; // Repeat for longer scroll
      });
    }

    // Render Logo (Real-time)
    function renderLogo() {
      const logoContainer = document.getElementById('navbarLogoContainer');
      const fallbackLogo = `
        <div class="fallback-logo">
          <span style="font-weight:700; color:var(--primary)">د</span>
        </div>`;
      
      onSnapshot(doc(db, "siteConfig", "logo"), (docSnap) => {
        if (docSnap.exists() && docSnap.data().logoData) {
          siteData.logo = docSnap.data().logoData;
          logoContainer.innerHTML = `<img src="${siteData.logo}" alt="Logo" id="navbarLogo" style="margin-inline-start:.6rem">`;
        } else {
          siteData.logo = null;
          logoContainer.innerHTML = fallbackLogo;
        }
      });
    }

    // Render Homepage (Hero)
    function renderHomepage() {
      document.getElementById('heroTitle').textContent = siteData.lang === 'ur' ? siteData.config.heroTitleUr : siteData.config.heroTitleEn;
      document.getElementById('heroSubtitle').textContent = siteData.lang === 'ur' ? siteData.config.heroSubtitleUr : siteData.config.heroSubtitleEn;
    }

    // Render About Us
    function renderAbout() {
      document.getElementById('aboutHeading').textContent = siteData.lang === 'ur' ? i18n.ur.adminAbout : i18n.en.adminAbout;
      document.getElementById('aboutText').textContent = siteData.lang === 'ur' ? siteData.config.aboutTextUr : siteData.config.aboutTextEn;
      document.getElementById('aboutImage').src = siteData.config.aboutImage;
    }
    
    // Render Donation Settings
    function renderDonationSettings() {
      const upiId = siteData.config.upiId || 'your-upi-id@ok';
      const upiLink = `upi://pay?pa=${upiId}&pn=Darut%20Taleem%20Wat%20Tarbiyah&am=&cu=INR&tn=Donation`;
      const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(upiLink)}`;
      
      document.getElementById('donationQR').src = qrUrl;
      document.getElementById('payNowLink').href = upiLink;
      document.getElementById('upiIdInput').value = upiId;
    }
    
    // Render Fonts
    function renderFonts() {
      document.documentElement.style.setProperty('--font-ur', siteData.config.fontUr);
      document.documentElement.style.setProperty('--font-en', siteData.config.fontEn);
    }
    
    // Load and Render all Site Config data
    async function renderSiteConfig() {
      const docRef = doc(db, "siteConfig", "main");
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        // Merge fetched config with defaults
        siteData.config = { ...siteData.config, ...docSnap.data() };
      }
      // Now render all components that depend on this config
      renderHomepage();
      renderAbout();
      renderDonationSettings();
      renderFonts();
      
      // Also apply language
      applyLanguage(siteData.lang);
    }

    // Render courses
    async function renderCourses(){
      const container = document.getElementById('coursesList');
      container.innerHTML = '<p>Loading courses...</p>';
      
      const snapshot = await getDocs(collection(db, "courses"));
      
      container.innerHTML = '';
      if (snapshot.empty) {
        container.innerHTML = '<p>No courses added yet.</p>';
        return;
      }
      
      snapshot.forEach(doc => {
        const c = doc.data();
        const col = document.createElement('div'); col.className = 'col-md-6 col-lg-4';
        col.innerHTML = `
          <div class="card card-course h-100">
            <div class="card-body">
              <h5 class="card-title">${siteData.lang === 'ur' ? c.titleUr : c.titleEn}</h5>
              <p class="card-text">${siteData.lang === 'ur' ? c.descUr : c.descEn}</p>
            </div>
            <div class="card-footer small text-muted">${c.duration || ''}</div>
          </div>
        `;
        container.appendChild(col);
      });
    }

    // Render events
    async function renderEvents(){
      const container = document.getElementById('eventsList');
      container.innerHTML = '<p>Loading events...</p>';
      
      const snapshot = await getDocs(collection(db, "events"));
      
      container.innerHTML = '';
      if (snapshot.empty) {
        container.innerHTML = '<p>No events scheduled.</p>';
        return;
      }
      
      const lang = siteData.lang;
      const months = lang === 'ur' 
        ? ["جنوری", "فروری", "مارچ", "اپریل", "مئی", "جون", "جولائی", "اگست", "ستمبر", "اکتوبر", "نومبر", "دسمبر"]
        : ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];

      snapshot.forEach(doc => {
        const event = doc.data();
        const eventDate = new Date(event.date);
        const day = eventDate.getDate();
        const month = months[eventDate.getMonth()];

        const col = document.createElement('div'); col.className = 'col-md-6';
        col.innerHTML = `
          <div class="event-card h-100">
            <div class="event-card-date">
              <span class="day">${day}</span>
              <span class="month">${month}</span>
            </div>
            <div class="event-card-body">
              <h5>${lang === 'ur' ? event.titleUr : event.titleEn}</h5>
              <p>${lang === 'ur' ? event.descUr : event.descEn}</p>
            </div>
          </div>
        `;
        container.appendChild(col);
      });
    }
    
    // Render Custom Sections
    async function renderCustomSections() {
      const container = document.getElementById('customSectionsContainer');
      container.innerHTML = '';
      
      const snapshot = await getDocs(collection(db, "customSections"));
      
      if (snapshot.empty) {
        return;
      }
      
      const lang = siteData.lang;
      snapshot.forEach(doc => {
        const section = doc.data();
        const sectionEl = document.createElement('section');
        sectionEl.className = 'mb-5';
        
        // Image position logic
        const imgCol = `<div class="col-lg-6"><img src="${section.imageData}" alt="${lang === 'ur' ? section.titleUr : section.titleEn}" class="custom-section-img"></div>`;
        const textCol = `
          <div class="col-lg-6">
            <h3>${lang === 'ur' ? section.titleUr : section.titleEn}</h3>
            <p>${lang === 'ur' ? section.textUr : section.textEn}</p>
          </div>
        `;
        
        const rowContent = section.imagePosition === 'right' 
          ? `${textCol} ${imgCol}` 
          : `${imgCol} ${textCol}`;

        sectionEl.innerHTML = `
          <div class="section-title mb-3">
            <h2>${lang === 'ur' ? section.titleUr : section.titleEn}</h2>
          </div>
          <div classs="row gy-4 align-items-center">
            ${rowContent}
          </div>
        `;
        // This is a bug in the original code, classs="row" should be class="row"
        // Fixing it now:
        sectionEl.querySelector('[classs="row gy-4 align-items-center"]').setAttribute('class', 'row gy-4 align-items-center');
        
        container.appendChild(sectionEl);
      });
    }

    // Render gallery
    async function renderGallery(){
      const grid = document.getElementById('galleryGrid');
      grid.innerHTML = '<p>Loading gallery...</p>';
      
      const snapshot = await getDocs(collection(db, "gallery"));
      
      grid.innerHTML = '';
      if (snapshot.empty) {
        grid.innerHTML = '<p>No images in gallery yet.</p>';
        return;
      }

      snapshot.forEach(doc => {
        const img = doc.data();
        const imgEl = document.createElement('img');
        imgEl.src = img.imageData;
        imgEl.alt = img.name || 'Gallery';
        grid.appendChild(imgEl);
      });
    }

    // Contact form submission
    document.getElementById('contactForm').addEventListener('submit', async function(e){
      e.preventDefault();
      const name = document.getElementById('contactName').value.trim();
      const email = document.getElementById('contactEmail').value.trim();
      const subject = document.getElementById('contactSubject').value.trim();
      const message = document.getElementById('contactMessage').value.trim();
      
      try {
        await addDoc(collection(db, "messages"), {
          name, email, subject, message,
          created: new Date().toISOString()
        });
        this.reset();
        showToast('پیغام موصول ہوگیا — ہم جلد رابطہ کریں گے', 'success');
      } catch (error) {
        console.error("Error adding message: ", error);
        showToast('Error sending message. Please try again.', 'danger');
      }
    });

    // ----------------- Donation Form Logic -----------------
    const donationTypeSelect = document.getElementById('donationType');
    const otherDonationTypeContainer = document.getElementById('otherDonationTypeContainer');
    
    donationTypeSelect.addEventListener('change', function() {
      otherDonationTypeContainer.style.display = (this.value === 'Other') ? 'block' : 'none';
    });
    
    document.getElementById('donationForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      let donationType = donationTypeSelect.value;
      if (donationType === 'Other') {
        donationType = document.getElementById('otherDonationType').value.trim() || 'Other';
      }

      const donation = {
        amount: document.getElementById('donationAmount').value,
        type: donationType,
        name: document.getElementById('donationName').value.trim(),
        phone: document.getElementById('donationPhone').value.trim(),
        address: document.getElementById('donationAddress').value.trim(),
        email: document.getElementById('donationEmail').value.trim(),
        docId: document.getElementById('donationDocId').value.trim(),
        created: new Date().toISOString()
      };
      
      try {
        // Save donation request
        await addDoc(collection(db, "donations"), donation);
        
        // Show payment info
        document.getElementById('donationPaymentInfo').style.display = 'block';
        showToast('Form submitted. Please complete the payment.', 'success');
        
      } catch (error) {
        console.error("Error saving donation: ", error);
        showToast('Error saving submission. Please try again.', 'danger');
      }
    });
    
    // Copy UPI button
    document.getElementById('copyUpiButton').addEventListener('click', function() {
      const upiInput = document.getElementById('upiIdInput');
      try {
        upiInput.select();
        upiInput.setSelectionRange(0, 99999); // For mobile
        document.execCommand('copy');
        
        const lang = siteData.lang;
        showToast(i18n[lang].copiedToast, 'success');

      } catch (err) {
        console.error('Failed to copy UPI ID: ', err);
        showToast('Failed to copy', 'danger');
      }
    });

    // ----------------- Admin interactions -----------------
    const adminModalEl = document.getElementById('adminModal');
    const adminModal = new bootstrap.Modal(adminModalEl);
    const adminButton = document.getElementById('openAdmin');
    
    adminButton.addEventListener('click',(e)=>{ 
      e.preventDefault();
      adminModal.show();
    });
    
    // Fix modal focus bug (aria-hidden warning)
    adminModalEl.addEventListener('hidden.bs.modal', () => {
      adminButton.focus();
    });

    // Admin Login
    document.getElementById('adminLoginForm').addEventListener('submit', async function(e){
      e.preventDefault();
      const email = document.getElementById('adminUser').value;
      const pass = document.getElementById('adminPass').value;
      
      try {
        await signInWithEmailAndPassword(auth, email, pass);
        // On success, onAuthStateChanged will handle panel switching
        showToast('Login successful!', 'success');
      } catch (error) {
        console.error("Login failed:", error.message);
        showToast(error.message, 'danger');
      }
    });

    // Admin Logout
    document.getElementById('adminLogout').addEventListener('click', ()=>{
      signOut(auth);
      showToast('Logged out.', 'success');
    });

    // Auth state brain
    onAuthStateChanged(auth, user => {
      if (user) {
        // User is LOGGED IN
        document.getElementById('adminLoginView').style.display = 'none';
        document.getElementById('adminPanelView').style.display = 'block';
        loadAdminPanel('ann'); // Load default panel
      } else {
        // User is LOGGED OUT
        document.getElementById('adminLoginView').style.display = 'block';
        document.getElementById('adminPanelView').style.display = 'none';
      }
    });

    // Panel nav buttons
    document.querySelectorAll('[data-panel]').forEach(btn=> btn.addEventListener('click', ()=> loadAdminPanel(btn.dataset.panel) ))
    
    // Main Admin Panel Loader
    async function loadAdminPanel(panel){
      const content = document.getElementById('panelContent');
      content.innerHTML = `<h5>Loading ${panel}...</h5>`;
      
      // Update active button state
      document.querySelectorAll('[data-panel]').forEach(b => {
        b.classList.toggle('active', b.dataset.panel === panel)
      });

      // --- Announcements Panel ---
      if(panel === 'ann'){
        const snapshot = await getDocs(collection(db, "announcements"));
        let listHtml = '';
        snapshot.forEach(snapshotDoc => { // Renamed doc to snapshotDoc
          const a = snapshotDoc.data();
          listHtml += `
            <div class="card mb-2 p-2">
              <div class="d-flex justify-content-between align-items-center">
                <div>${a.text}</div>
                <div><button class="btn btn-sm btn-danger" data-id="${snapshotDoc.id}">Delete</button></div>
              </div>
            </div>
          `;
        });
        
        content.innerHTML = `
          <h5>Announcements</h5>
          <form id="annForm" class="mb-3">
            <div class="mb-2"><textarea id="annText" class="form-control" rows="2" placeholder="Add announcement in Urdu or English"></textarea></div>
            <button class="btn btn-success btn-sm">Add</button>
          </form>
          <div id="annsList">${listHtml}</div>
        `;
        
        document.getElementById('annForm').addEventListener('submit', async function(e){
          e.preventDefault(); 
          const text = document.getElementById('annText').value.trim(); 
          if(!text) return;
          try {
            await addDoc(collection(db, "announcements"), { text });
            showToast('Announcement added!', 'success');
            loadAdminPanel('ann');
          } catch(err) { showToast(err.message, 'danger'); }
        });
        
        document.getElementById('annsList').addEventListener('click', async (e) => {
          if (e.target.dataset.id) {
            if (!confirm('Are you sure you want to delete this?')) return;
            try {
              await deleteDoc(doc(db, "announcements", e.target.dataset.id)); // doc() is available
              showToast('Deleted!', 'success');
              loadAdminPanel('ann');
            } catch(err) { showToast(err.message, 'danger'); }
          }
        });
      }

      // --- Homepage (Hero) Panel ---
      if(panel === 'hero'){
        content.innerHTML = `
          <h5>Homepage (Hero)</h5>
          <form id="heroForm">
            <div class="mb-3">
              <label class="form-label">Hero Title (Urdu)</label>
              <input type="text" id="heroTitleUr" class="form-control" value="${siteData.config.heroTitleUr}">
            </div>
            <div class="mb-3">
              <label class="form-label">Hero Title (English)</label>
              <input type="text" id="heroTitleEn" class="form-control" value="${siteData.config.heroTitleEn}">
            </div>
            <div class="mb-3">
              <label class="form-label">Hero Subtitle (Urdu)</label>
              <input type="text" id="heroSubtitleUr" class="form-control" value="${siteData.config.heroSubtitleUr}">
            </div>
            <div class="mb-3">
              <label class="form-label">Hero Subtitle (English)</label>
              <input type="text" id="heroSubtitleEn" class="form-control" value="${siteData.config.heroSubtitleEn}">
            </div>
            <button class="btn btn-primary">Save Settings</button>
          </form>
        `;
        
        document.getElementById('heroForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          const newConfig = {
            heroTitleUr: document.getElementById('heroTitleUr').value,
            heroTitleEn: document.getElementById('heroTitleEn').value,
            heroSubtitleUr: document.getElementById('heroSubtitleUr').value,
            heroSubtitleEn: document.getElementById('heroSubtitleEn').value
          };
          try {
            await setDoc(doc(db, "siteConfig", "main"), newConfig, { merge: true });
            // Update local state and re-render
            siteData.config = { ...siteData.config, ...newConfig };
            renderHomepage();
            showToast('Homepage updated!', 'success');
          } catch(err) { showToast(err.message, 'danger'); }
        });
      }
      
      // --- About Us Panel ---
      if(panel === 'about'){
        content.innerHTML = `
          <h5>About Us</h5>
          <form id="aboutForm">
            <div class="mb-3">
              <label class="form-label">About Text (Urdu)</label>
              <textarea id="aboutTextUr" class="form-control" rows="4">${siteData.config.aboutTextUr}</textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">About Text (English)</label>
              <textarea id="aboutTextEn" class="form-control" rows="4">${siteData.config.aboutTextEn}</textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">About Image</label>
              <input type="file" id="aboutImageFile" class="form-control" accept="image/png, image/jpeg, image/webp">
              <small>Upload new image, or leave blank to keep current one.</small>
              <img src="${siteData.config.aboutImage}" class="admin-preview-img" id="aboutImgPreview">
            </div>
            <button class="btn btn-primary">Save Settings</button>
          </form>
        `;
        
        document.getElementById('aboutForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          
          let newImageData = siteData.config.aboutImage;
          const file = document.getElementById('aboutImageFile').files[0];
          
          try {
            if (file) {
              showToast('Compressing image...', 'success');
              newImageData = await fileToResizedBase64(file, { maxWidth: 1024, maxHeight: 1024 });
            }
            
            const newConfig = {
              aboutTextUr: document.getElementById('aboutTextUr').value,
              aboutTextEn: document.getElementById('aboutTextEn').value,
              aboutImage: newImageData
            };
            
            await setDoc(doc(db, "siteConfig", "main"), newConfig, { merge: true });
            // Update local state and re-render
            siteData.config = { ...siteData.config, ...newConfig };
            renderAbout();
            document.getElementById('aboutImgPreview').src = newImageData;
            showToast('About Us updated!', 'success');
            
          } catch(err) { showToast(err.message, 'danger'); }
        });
      }

      // --- Courses Panel ---
      if(panel === 'courses'){
        const snapshot = await getDocs(collection(db, "courses"));
        let listHtml = '';
        snapshot.forEach(snapshotDoc => {
          const c = snapshotDoc.data();
          listHtml += `
            <div class="card mb-2 p-2">
              <div class="d-flex justify-content-between align-items-start">
                <div><strong>${c.titleUr || c.titleEn}</strong><div class="small text-muted">${c.duration || ''}</div></div>
                <div><button class="btn btn-sm btn-danger" data-id="${snapshotDoc.id}">Delete</button></div>
              </div>
            </div>`;
        });
        
        content.innerHTML = `
          <h5>Courses</h5>
          <form id="courseForm" class="mb-3">
            <div class="row g-2">
              <div class="col-md-6"><input id="courseTitleUr" class="form-control" placeholder="Title (Urdu)"></div>
              <div class="col-md-6"><input id="courseTitleEn" class="form-control" placeholder="Title (English)"></div>
            </div>
            <div class="row g-2 mt-2">
              <div class="col-md-6"><input id="courseDuration" class="form-control" placeholder="Duration"></div>
              <div class="col-md-6"><input id="courseDescEn" class="form-control" placeholder="Short description (English)"></div>
            </div>
            <div class="mt-2"><textarea id="courseDescUr" class="form-control" placeholder="Short description (Urdu)"></textarea></div>
            <div class="mt-2"><button class="btn btn-success btn-sm">Add Course</button></div>
          </form>
          <div id="coursesListAdmin">${listHtml}</div>
        `;
        
        document.getElementById('courseForm').addEventListener('submit', async function(e){
          e.preventDefault();
          const course = {
            titleUr: document.getElementById('courseTitleUr').value || '',
            titleEn: document.getElementById('courseTitleEn').value || '',
            descUr: document.getElementById('courseDescUr').value || '',
            descEn: document.getElementById('courseDescEn').value || '',
            duration: document.getElementById('courseDuration').value || ''
          };
          try {
            await addDoc(collection(db, "courses"), course);
            showToast('Course added!', 'success');
            renderCourses();
            loadAdminPanel('courses');
          } catch(err) { showToast(err.message, 'danger'); }
        });

        document.getElementById('coursesListAdmin').addEventListener('click', async (e) => {
          if (e.target.dataset.id) {
            if (!confirm('Are you sure you want to delete this?')) return;
            try {
              await deleteDoc(doc(db, "courses", e.target.dataset.id));
              showToast('Deleted!', 'success');
              renderCourses();
              loadAdminPanel('courses');
            } catch(err) { showToast(err.message, 'danger'); }
          }
        });
      }

      // --- Events Panel ---
      if(panel === 'events'){
        const snapshot = await getDocs(collection(db, "events"));
        let listHtml = '';
        snapshot.forEach(snapshotDoc => {
          const e = snapshotDoc.data();
          listHtml += `
            <div class="card mb-2 p-2">
              <div class="d-flex justify-content-between align-items-start">
                <div><strong>${e.titleUr || e.titleEn}</strong><div class="small text-muted">${e.date}</div></div>
                <div><button class="btn btn-sm btn-danger" data-id="${snapshotDoc.id}">Delete</button></div>
              </div>
            </div>`;
        });

        content.innerHTML = `
          <h5>Events</h5>
          <form id="eventForm" class="mb-3">
            <div class="row g-2">
              <div class="col-md-6"><input id="eventTitleUr" class="form-control" placeholder="Event Title (Urdu)" required></div>
              <div class="col-md-6"><input id="eventTitleEn" class="form-control" placeholder="Event Title (English)"></div>
            </div>
            <div class="row g-2 mt-2">
              <div class="col-md-6"><input id="eventDate" type="date" class="form-control" required></div>
            </div>
            <div class="mt-2"><textarea id="eventDescUr" class="form-control" placeholder="Short description (Urdu)"></textarea></div>
            <div class="mt-2"><textarea id="eventDescEn" class="form-control" placeholder="Short description (English)"></textarea></div>
            <div class="mt-2"><button class="btn btn-success btn-sm">Add Event</button></div>
          </form>
          <div id="eventsListAdmin">${listHtml}</div>
        `;
        
        document.getElementById('eventForm').addEventListener('submit', async function(e){
          e.preventDefault();
          const event = {
            titleUr: document.getElementById('eventTitleUr').value || '',
            titleEn: document.getElementById('eventTitleEn').value || '',
            descUr: document.getElementById('eventDescUr').value || '',
            descEn: document.getElementById('eventDescEn').value || '',
            date: document.getElementById('eventDate').value
          };
          try {
            await addDoc(collection(db, "events"), event);
            showToast('Event added!', 'success');
            renderEvents();
            loadAdminPanel('events');
          } catch(err) { showToast(err.message, 'danger'); }
        });
        
        document.getElementById('eventsListAdmin').addEventListener('click', async (e) => {
          if (e.target.dataset.id) {
            if (!confirm('Are you sure you want to delete this?')) return;
            try {
              await deleteDoc(doc(db, "events", e.target.dataset.id));
              showToast('Event deleted!', 'success');
              renderEvents();
              loadAdminPanel('events');
            } catch(err) { showToast(err.message, 'danger'); }
          }
        });
      }
      
      // --- Custom Sections Panel ---
      if (panel === 'customSections') {
        const snapshot = await getDocs(collection(db, "customSections"));
        let listHtml = '';
        snapshot.forEach(snapshotDoc => {
          const s = snapshotDoc.data();
          listHtml += `
            <div class="card mb-2 p-2">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <strong>${s.titleUr || s.titleEn}</strong>
                  <img src="${s.imageData}" style="width: 50px; height: 50px; object-fit: cover; margin-left: 10px;">
                </div>
                <div><button class="btn btn-sm btn-danger" data-id="${snapshotDoc.id}">Delete</button></div>
              </div>
            </div>`;
        });

        content.innerHTML = `
          <h5>Custom Homepage Sections</h5>
          <form id="customSectionForm" class="mb-3">
            <div class="row g-2">
              <div class="col-md-6"><input id="csTitleUr" class="form-control" placeholder="Title (Urdu)" required></div>
              <div class="col-md-6"><input id="csTitleEn" class="form-control" placeholder="Title (English)"></div>
            </div>
            <div class="mt-2"><textarea id="csTextUr" class="form-control" placeholder="Text (Urdu)"></textarea></div>
            <div class="mt-2"><textarea id="csTextEn" class="form-control" placeholder="Text (English)"></textarea></div>
            <div class="row g-2 mt-2">
              <div class="col-md-6">
                <label class="form-label">Image</label>
                <input type="file" id="csFile" class="form-control" accept="image/png, image/jpeg, image/webp" required>
                <small>Image will be resized to ~800px width.</small>
              </div>
              <div class="col-md-6">
                <label class="form-label">Image Position</label>
                <select id="csImgPos" class="form-select">
                  <option value="left" selected>Left</option>
                  <option value="right">Right</option>
                </select>
              </div>
            </div>
            <div class="mt-2"><button class="btn btn-success btn-sm">Add Section</button></div>
          </form>
          <div id="customSectionsListAdmin">${listHtml}</div>
        `;

        document.getElementById('customSectionForm').addEventListener('submit', async function(e){
          e.preventDefault();
          const file = document.getElementById('csFile').files[0];
          if (!file) {
            showToast('Please select an image.', 'danger');
            return;
          }
          
          try {
            showToast('Uploading image...', 'success');
            const imageData = await fileToResizedBase64(file, { maxWidth: 800 });
            
            const section = {
              titleUr: document.getElementById('csTitleUr').value || '',
              titleEn: document.getElementById('csTitleEn').value || '',
              textUr: document.getElementById('csTextUr').value || '',
              textEn: document.getElementById('csTextEn').value || '',
              imagePosition: document.getElementById('csImgPos').value,
              imageData: imageData
            };
            
            await addDoc(collection(db, "customSections"), section);
            showToast('Section added!', 'success');
            renderCustomSections();
            loadAdminPanel('customSections');
            
          } catch(err) { showToast(err.message, 'danger'); }
        });

        document.getElementById('customSectionsListAdmin').addEventListener('click', async (e) => {
          if (e.target.dataset.id) {
            if (!confirm('Are you sure you want to delete this?')) return;
            try {
              await deleteDoc(doc(db, "customSections", e.target.dataset.id));
              showToast('Section deleted!', 'success');
              renderCustomSections();
              loadAdminPanel('customSections');
            } catch(err) { showToast(err.message, 'danger'); }
          }
        });
      }

      // --- Gallery Panel ---
      if(panel === 'gallery'){
        const snapshot = await getDocs(collection(db, "gallery"));
        let listHtml = '';
        snapshot.forEach(snapshotDoc => {
          const g = snapshotDoc.data();
          listHtml += `
            <div class="d-inline-block text-center me-2 mb-2">
              <img src="${g.imageData}" style="width:100px; height:100px; object-fit:cover; border-radius:6px">
              <button class="btn btn-sm btn-danger mt-1" data-id="${snapshotDoc.id}">Delete</button>
            </div>`;
        });
        
        content.innerHTML = `
          <h5>Gallery</h5>
          <form id="galleryForm" class="mb-3">
            <div class="mb-2"><input id="galleryFile" type="file" accept="image/*" class="form-control" required></div>
            <div class="mb-2"><input id="galleryName" class="form-control" placeholder="Image name (optional)"></div>
            <small>Note: Images will be compressed and resized to 800x800. Please use JPG/PNG files under 750KB.</small>
            <div class="mt-2"><button class="btn btn-success btn-sm">Upload</button></div>
          </form>
          <div id="galleryAdminList">${listHtml}</div>
        `;
        
        document.getElementById('galleryForm').addEventListener('submit', async function(e){
          e.preventDefault(); 
          const file = document.getElementById('galleryFile').files[0];
          if(!file){ return }
          
          try {
            showToast('Uploading image...', 'success');
            const imageData = await fileToResizedBase64(file, { maxWidth: 800, maxHeight: 800 });
            const name = document.getElementById('galleryName').value || file.name;
            
            await addDoc(collection(db, "gallery"), { imageData, name });
            
            showToast('Image added!', 'success');
            renderGallery();
            loadAdminPanel('gallery');
            
          } catch(err) { showToast(err.message, 'danger'); }
        });
        
        document.getElementById('galleryAdminList').addEventListener('click', async (e) => {
          if (e.target.dataset.id) {
            if (!confirm('Are you sure you want to delete this?')) return;
            try {
              await deleteDoc(doc(db, "gallery", e.target.dataset.id));
              showToast('Image deleted!', 'success');
              renderGallery();
              loadAdminPanel('gallery');
            } catch(err) { showToast(err.message, 'danger'); }
          }
        });
      }

      // --- Logo Panel ---
      if(panel === 'logo'){
        content.innerHTML = `
          <h5 id="adminLogoTitle">Logo</h5>
          <p>Upload a logo to replace the default initial in the navbar. Use a PNG with a transparent background.</p>
          <div class="mb-3">
            <label class="form-label">Current Logo</label>
            <div>
              ${siteData.logo ? `<img src="${siteData.logo}" id="adminLogoPreview" alt="Logo">` : '<span class="text-muted">No logo uploaded</span>'}
            </div>
          </div>
          <form id="logoForm" class="mb-3">
            <div class="mb-2">
              <input id="logoFile" type="file" accept="image/png, image/jpeg, image/svg+xml, image/webp" class="form-control">
              <small>Logo will be resized to 100px height.</small>
            </div>
            <button class="btn btn-success btn-sm">Save Logo</button>
          </form>
          <button class="btn btn-outline-danger btn-sm" id="removeLogoButton" ${!siteData.logo ? 'disabled' : ''}>Remove Logo</button>
        `;

        document.getElementById('logoForm').addEventListener('submit', async function(e){
          e.preventDefault();
          const file = document.getElementById('logoFile').files[0];
          if(!file) { return }
          
          try {
            showToast('Uploading logo...', 'success');
            const logoData = await fileToResizedBase64(file, { maxHeight: 100 });
            
            await setDoc(doc(db, "siteConfig", "logo"), { logoData });
            
            showToast('Logo updated!', 'success');
            // renderLogo() is called by onSnapshot, so it updates automatically
            loadAdminPanel('logo');
            
          } catch(err) { showToast(err.message, 'danger'); }
        });

        document.getElementById('removeLogoButton').addEventListener('click', async function(){
          if (!confirm('Are you sure you want to remove the logo?')) return;
          try {
            await deleteDoc(doc(db, "siteConfig", "logo"));
            showToast('Logo removed', 'success');
            // renderLogo() is called by onSnapshot, so it updates automatically
            loadAdminPanel('logo');
          } catch(err) { showToast(err.message, 'danger'); }
        });
      }
      
      // --- Donation Settings Panel ---
      if (panel === 'donation') {
        content.innerHTML = `
          <h5>Donation Settings</h5>
          <form id="donationSettingsForm">
            <div class="mb-3">
              <label class="form-label">UPI ID</label>
              <input type="text" id="upiId" class="form-control" value="${siteData.config.upiId}">
              <small>Example: 123456789@okaxis</small>
            </div>
            <button class="btn btn-primary">Save Settings</button>
          </form>
        `;
        
        document.getElementById('donationSettingsForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          const newConfig = {
            upiId: document.getElementById('upiId').value
          };
          try {
            await setDoc(doc(db, "siteConfig", "main"), newConfig, { merge: true });
            // Update local state and re-render
            siteData.config = { ...siteData.config, ...newConfig };
            renderDonationSettings();
            showToast('Donation settings updated!', 'success');
          } catch(err) { showToast(err.message, 'danger'); }
        });
      }
      
      // --- Font Settings Panel ---
      if (panel === 'fonts') {
        let urOptionsHtml = fontOptions.ur.map(font => 
          `<option value="${font.value}" ${siteData.config.fontUr === font.value ? 'selected' : ''}>${font.name}</option>`
        ).join('');
        
        let enOptionsHtml = fontOptions.en.map(font => 
          `<option value="${font.value}" ${siteData.config.fontEn === font.value ? 'selected' : ''}>${font.name}</option>`
        ).join('');

        content.innerHTML = `
          <h5>Font Settings</h5>
          <form id="fontSettingsForm">
            <div class="mb-3">
              <label class="form-label">Urdu Font</label>
              <select id="fontUrSelect" class="form-select">${urOptionsHtml}</select>
            </div>
            <div class="mb-3">
              <label class="form-label">English Font</label>
              <select id="fontEnSelect" class="form-select">${enOptionsHtml}</select>
            </div>
            <button class="btn btn-primary">Save Settings</button>
          </form>
        `;
        
        document.getElementById('fontSettingsForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          const newConfig = {
            fontUr: document.getElementById('fontUrSelect').value,
            fontEn: document.getElementById('fontEnSelect').value
          };
          try {
            await setDoc(doc(db, "siteConfig", "main"), newConfig, { merge: true });
            // Update local state and re-render
            siteData.config = { ...siteData.config, ...newConfig };
            renderFonts();
            showToast('Font settings updated!', 'success');
          } catch(err) { showToast(err.message, 'danger'); }
        });
      }

      // --- Messages Panel ---
      if(panel === 'messages'){
        const snapshot = await getDocs(collection(db, "messages"));
        let listHtml = '';
        snapshot.forEach(doc => {
          const m = doc.data();
          listHtml += `
            <div class="card mb-2 p-2">
              <div>
                <strong>${m.name} — ${m.email}</strong>
                <div class="small text-muted">${new Date(m.created).toLocaleString()}</div>
                <p class="mb-1 mt-1"><strong>Subject:</strong> ${m.subject || 'N/A'}</p>
                <p>${m.message}</p>
              </div>
            </div>`;
        });
        
        content.innerHTML = `
          <h5>Messages</h5>
          <small>These are messages from your contact form.</small>
          <div id="msgsList" class="mt-3">${listHtml}</div>
        `;
      }
      
      // --- Donations Panel ---
      if(panel === 'donations'){
        const snapshot = await getDocs(collection(db, "donations"));
        let listHtml = '';
        snapshot.forEach(doc => {
          const d = doc.data();
          listHtml += `
            <div class="card mb-2 p-2">
              <div class="d-flex justify-content-between">
                <strong>${d.name} (₹${d.amount})</strong>
                <span class="badge bg-primary">${d.type}</span>
              </div>
              <div class="small text-muted">${new Date(d.created).toLocaleString()}</div>
              <p class="mb-1 mt-2">
                <strong>Phone:</strong> ${d.phone}<br>
                <strong>Email:</strong> ${d.email}<br>
                <strong>Address:</strong> ${d.address}<br>
                <strong>Doc ID:</strong> ${d.docId}
              </p>
            </div>`;
        });
        
        content.innerHTML = `
          <h5 id="adminDonationsTitle">Donations</h5>
          <small>These are donation form submissions.</small>
          <div id="donationsList" class="mt-3">${listHtml}</div>
        `;
      }
    }

    // ----------------- Language switching -----------------
    const langSelect = document.getElementById('langToggle')
    
    function applyLanguage(lang){
      siteData.lang = lang; // Store current language
      const root = document.documentElement
      if(lang === 'ur'){
        root.lang = 'ur'; root.dir = 'rtl'
      } else {  
        root.lang = 'en'; root.dir = 'ltr'  
      }

      // apply texts
      const t = i18n[lang]
      
      // Navbar
      document.getElementById('brandTitle').textContent = t.brandTitle
      document.getElementById('brandSubtitle').textContent = t.brandSubtitle
      document.getElementById('navHome').textContent = t.navHome
      document.getElementById('navAbout').textContent = t.navAbout
      document.getElementById('navCourses').textContent = t.navCourses
      document.getElementById('navEvents').textContent = t.navEvents
      document.getElementById('navGallery').textContent = t.navGallery
      document.getElementById('navLibrary').textContent = t.navLibrary
      document.getElementById('navDonation').textContent = t.navDonation
      document.getElementById('navContact').textContent = t.navContact
      document.getElementById('openAdmin').textContent = t.navAdmin
      
      // Hero (Dynamic)
      renderHomepage();
      document.getElementById('heroBtn1').textContent = t.heroBtn1;
      document.getElementById('heroBtn2').textContent = t.heroBtn2;

      // Quick Links
      document.getElementById('qLinkDonation').textContent = t.qLinkDonation
      document.getElementById('qLinkFatwa').textContent = t.qLinkFatwa
      document.getElementById('qLinkBooks').textContent = t.qLinkBooks
      document.getElementById('qLinkGallery').textContent = t.qLinkGallery

      // Dynamic Content
      renderAbout(); // Renders About Us text in correct language
      renderSiteConfig(); // Re-applies all config
      
      // Static Content
      document.getElementById('coursesHeading').textContent = t.coursesHeading
      document.getElementById('eventsHeading').textContent = t.eventsHeading
      document.getElementById('galleryHeading').textContent = t.galleryHeading
      
      // Library Section
      document.getElementById('libraryHeading').textContent = t.libraryHeading
      document.getElementById('libraryCardTitle').textContent = t.libraryCardTitle
      document.getElementById('libraryCardText').textContent = t.libraryCardText
      document.getElementById('libraryCardButton').textContent = t.libraryCardButton

      // Donation Section
      document.getElementById('donationHeading').textContent = t.donationHeading
      document.getElementById('lblDonationAmount').textContent = t.lblDonationAmount
      document.getElementById('lblDonationType').textContent = t.lblDonationType
      document.getElementById('optDonationGeneral').textContent = t.optDonationGeneral
      document.getElementById('optDonationZakat').textContent = t.optDonationZakat
      document.getElementById('optDonationSadqa').textContent = t.optDonationSadqa
      document.getElementById('optDonationConstruction').textContent = t.optDonationConstruction
      document.getElementById('optDonationOther').textContent = t.optDonationOther
      document.getElementById('lblOtherDonationType').textContent = t.lblOtherDonationType
      document.getElementById('lblDonationName').textContent = t.lblDonationName
      document.getElementById('lblDonationPhone').textContent = t.lblDonationPhone
      document.getElementById('lblDonationAddress').textContent = t.lblDonationAddress
      document.getElementById('lblDonationEmail').textContent = t.lblDonationEmail
      document.getElementById('lblDonationDocId').textContent = t.lblDonationDocId
      document.getElementById('donationSubmit').textContent = t.donationSubmit
      document.getElementById('donationPaymentTitle').textContent = t.donationPaymentTitle
      document.getElementById('donationPaymentSubtitle').textContent = t.donationPaymentSubtitle
      document.getElementById('copyUpiBtnText').textContent = t.copyUpiBtnText
      document.getElementById('payNowBtnText').textContent = t.payNowBtnText

      // Contact
      document.getElementById('contactHeading').textContent = t.contactHeading
      document.getElementById('lblName').textContent = t.lblName
      document.getElementById('lblEmail').textContent = t.lblEmail
      document.getElementById('lblSubject').textContent = t.lblSubject
      document.getElementById('lblMessage').textContent = t.lblMessage
      document.getElementById('contactSubmit').textContent = t.contactSubmit
      document.getElementById('contactInfoHeading').textContent = t.contactInfoHeading
      
      document.getElementById('lblAddress').textContent = t.lblAddress
      document.getElementById('lblPhone').textContent = t.lblPhone
      document.getElementById('lblContactEmail').textContent = t.lblContactEmail
      document.getElementById('lblMap').textContent = t.lblMap
      document.getElementById('linkMap').textContent = t.linkMap
      document.getElementById('contactFormNote').textContent = t.contactFormNote

      // Admin panel
      document.getElementById('adminNavDonations').textContent = t.adminDonations;
      document.querySelector('[data-panel="logo"]').textContent = t.adminLogo;
      document.querySelector('[data-panel="hero"]').textContent = t.adminHomepage;
      document.querySelector('[data-panel="about"]').textContent = t.adminAbout;
      document.querySelector('[data-panel="donation"]').textContent = t.adminDonationSettings;
      document.querySelector('[data-panel="events"]').textContent = t.adminEvents;
      document.querySelector('[data-panel="customSections"]').textContent = t.adminCustomSections;
      document.querySelector('[data-panel="fonts"]').textContent = t.adminFontSettings;
      document.getElementById('lblAdminEmail').textContent = t.lblAdminEmail;
      document.getElementById('lblAdminPass').textContent = t.lblAdminPass;
      
      // Re-render dynamic lists with new language
      renderCourses();
      renderEvents();
      renderCustomSections();
    }

    // default language = Urdu
    langSelect.addEventListener('change', ()=> applyLanguage(langSelect.value))
    applyLanguage('ur')

    // Smooth scroll for nav links
    document.querySelectorAll('[data-link]').forEach(a=> a.addEventListener('click', function(e){ e.preventDefault(); const id = this.getAttribute('href').slice(1); document.getElementById(id).scrollIntoView({behavior:'smooth'}) }))

    // ----------------- Dark Mode Toggle -----------------
    const darkModeToggle = document.getElementById('darkModeToggle');
    const sunIcon = darkModeToggle.querySelector('.bi-sun-fill');
    const moonIcon = darkModeToggle.querySelector('.bi-moon-fill');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
    const currentTheme = localStorage.getItem('theme');

    function setDarkMode(isDark) {
      if (isDark) {
        document.body.classList.add('dark-mode');
        sunIcon.style.display = 'inline-block';
        moonIcon.style.display = 'none';
        localStorage.setItem('theme', 'dark');
      } else {
        document.body.classList.remove('dark-mode');
        sunIcon.style.display = 'none';
        moonIcon.style.display = 'inline-block';
        localStorage.setItem('theme', 'light');
      }
    }

    // Initialize theme
    if (currentTheme === 'dark') {
      setDarkMode(true);
    } else if (currentTheme === 'light') {
      setDarkMode(false);
    } else {
      // No preference saved, use system preference
      setDarkMode(prefersDark.matches);
    }

    // Listen for toggle click
    darkModeToggle.addEventListener('click', () => {
      setDarkMode(!document.body.classList.contains('dark-mode'));
    });

    // Listen for system changes
    prefersDark.addEventListener('change', (e) => {
      // Only apply if no theme is manually set
      if (!localStorage.getItem('theme')) {
        setDarkMode(e.matches);
      }
    });

    // ----------------- Initial Data Load -----------------
    // Load all data from Firestore and render the page
    function loadAllData() {
      renderSiteConfig(); // This also calls renderHomepage, renderAbout, etc.
      renderAnnouncements();
      renderLogo();
      renderCourses();
      renderEvents();
      renderCustomSections();
      renderGallery();
    }
    
    loadAllData();

  </script>
</body>
</html>
