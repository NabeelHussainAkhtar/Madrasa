<!--
Madrasa Website (Bilingual: Urdu default + English)
SINGLE-FILE VERSION (Firebase + Netlify)
Features:
- Firebase Firestore (Database) for all content
- Firebase Authentication (Admin Login)
- Images stored as base64 data URLs in Firestore (100% Free)
- Bilingual (Ur/En) and Dark Mode
-->
<!doctype html>
<html lang="ur" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>دارالتعلیم والتربیہ - Darut Taleem Wat Tarbiyah</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Google Fonts: Poppins for English, Noto Nastaliq Urdu for fallback -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#007A3D; /* green */
      --secondary:#F7C948; /* gold */
      --bg:#ffffff;
      --card-bg: #f8f9fa;
    }
    html[dir="rtl"] body{font-family: 'Jameel Noori Nastaleeq', 'Noto Nastaliq Urdu', 'Noto Naskh Arabic', 'Noto Serif', serif;}
    html[dir="ltr"] body{font-family: 'Poppins', system-ui, -apple-system, 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', sans-serif;}
    body{background:var(--bg); color:#222; transition: background-color 0.3s, color 0.3s;}
    .navbar{background:linear-gradient(90deg,var(--primary), rgba(0,122,61,.9));}
    .navbar .nav-link, .navbar-brand{color:#fff !important}
    .hero{background: linear-gradient( rgba(0,0,0,0.25), rgba(0,0,0,0.25) ), url('https://images.unsplash.com/photo-1523942839745-7844d3d58c73?q=80&w=1770&auto=format&fit=crop&ixlib=rb-4.0.3&s=') center/cover no-repeat; color:#fff; padding:80px 0}
    .accent{color:var(--primary)}
    .card-course{border:1px solid #eee}
    
    /* Announcement bar - updated for marquee */
    .announcement-bar {
      background: var(--primary);
      color: #fff;
      padding: .25rem 0;
      font-weight: 600;
      overflow: hidden;
      white-space: nowrap;
    }
    .announcement-text {
      display: inline-block;
      padding-left: 100%; /* Start off-screen */
      animation: marquee 30s linear infinite;
    }
    [dir="rtl"] .announcement-text {
      animation-name: marquee-rtl;
      padding-right: 100%;
      padding-left: 0;
    }

    @keyframes marquee {
      0% { transform: translateX(0%); }
      100% { transform: translateX(-100%); }
    }
    @keyframes marquee-rtl {
      0% { transform: translateX(0%); }
      100% { transform: translateX(100%); }
    }
    
    .footer{background:#0b5132; color:#fff; padding:20px 0}

    /* Gallery grid */
    .gallery-grid{display:grid; grid-template-columns: repeat(auto-fit,minmax(280px,1fr)); gap:12px}
    .gallery-grid img{
      width:100%; 
      height: auto;
      aspect-ratio: 1 / 1; /* Makes it a perfect square */
      object-fit:cover; 
      border-radius:8px
    }

    .admin-panel{min-height:60vh}
    @media(min-width:992px){ .hero{padding:100px 0} }

    /* UPDATED HEADING ALIGNMENT RULES */
    [dir="rtl"] .section-title {
      width: 100%;
      text-align: right;
    }
    [dir="ltr"] .section-title {
      width: 100%;
      text-align: left;
    }

    /* Quick Links Grid */
    .quick-link-card {
      background-color: var(--card-bg);
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 1.5rem 1rem;
      text-align: center;
      transition: all 0.2s ease-in-out;
      text-decoration: none;
      color: #333;
      display: block;
      height: 100%;
    }
    .quick-link-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      color: var(--primary);
    }
    .quick-link-card svg {
      width: 40px;
      height: 40px;
      margin-bottom: 0.75rem;
      color: var(--primary);
    }
    .quick-link-card h5 {
      font-weight: 600;
      font-size: 1.1rem;
      margin: 0;
    }
    [dir="rtl"] .quick-link-card h5 {
      font-family: 'Jameel Noori Nastaleeq', 'Noto Nastaliq Urdu', serif;
      font-size: 1.4rem;
    }

    /* Dark Mode Styles */
    body.dark-mode {
      --bg: #121212;
      --card-bg: #1e1e1e;
      color: #e0e0e0;
    }
    body.dark-mode .card,
    body.dark-mode .modal-content,
    body.dark-mode .list-group-item {
      background-color: #1e1e1e;
      color: #e0e0e0;
      border-color: #333;
    }
    body.dark-mode .quick-link-card {
      color: #e0e0e0;
      border-color: #333;
    }
    body.dark-mode .form-control {
      background-color: #222;
      color: #fff;
      border-color: #444;
    }
    body.dark-mode .btn-close {
      filter: invert(1);
    }
    
    #adminLogoPreview, #navbarLogo {
      height: 40px;
      width: auto;
      max-width: 150px;
      object-fit: contain;
      border-radius: 6px;
      background-color: rgba(255,255,255,0.1);
    }
    #navbarLogoContainer .fallback-logo {
        width:46px; 
        height:46px; 
        background:var(--secondary); 
        border-radius:8px; 
        display:grid; 
        place-items:center; 
        margin-inline-start:.6rem
    }
    
    /* Ensure brand title font switches properly */
    [dir="ltr"] #brandTitle { font-family: 'Poppins', sans-serif; }
    [dir="rtl"] #brandTitle { font-family: 'Jameel Noori Nastaleeq', 'Noto Nastaliq Urdu', serif; }

    body.dark-mode #library .card,
    body.dark-mode #donationPaymentInfo { 
      background-color: #222; 
      border-color: #444; 
    }
    
    #contactInfo span[dir="ltr"] {
        display: inline-block;
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="#">
        <!-- Logo container -->
        <div id="navbarLogoContainer" class="d-flex align-items-center">
          <div class="fallback-logo">
            <span style="font-weight:700; color:var(--primary)">د</span>
          </div>
        </div>
        <div class="ms-2">
          <!-- Added IDs for i18n -->
          <div id="brandTitle" style="font-size:18px; line-height:1">دارالتعلیم والتربیہ</div>
          <small id="brandSubtitle" style="opacity:.9; font-size:12px">Darut Taleem Wat Tarbiyah</small>
        </div>
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navLinks">
        <span class="navbar-toggler-icon" style="filter:invert(1)"></span>
      </button>

      <div class="collapse navbar-collapse" id="navLinks">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="#home" data-link id="navHome">صفحہ اول</a></li>
          <li class="nav-item"><a class="nav-link" href="#about" data-link id="navAbout">ہمارے بارے میں</a></li>
          <li class="nav-item"><a class="nav-link" href="#courses" data-link id="navCourses">کورسز</a></li>
          <li class="nav-item"><a class="nav-link" href="#events" data-link id="navEvents">تقریبات</a></li>
          <li class="nav-item"><a class="nav-link" href="#gallery" data-link id="navGallery">گیلری</a></li>
          <li class="nav-item"><a class="nav-link" href="#customSections" data-link id="navSections">شعبے</a></li>
          <li class="nav-item"><a class="nav-link" href="#library" data-link id="navLibrary">کتب خانہ</a></li>
          <li class="nav-item"><a class="nav-link" href="#donation" data-link id="navDonation">عطیہ</a></li>
          <li class="nav-item"><a class="nav-link" href="#contact" data-link id="navContact">رابطہ کریں</a></li>
          <li class="nav-item"><a class="nav-link btn btn-sm btn-light text-dark ms-2" href="#admin" id="openAdmin">ایڈمن</a></li>
          <li class="nav-item d-flex align-items-center ms-2">
            <select id="langToggle" class="form-select form-select-sm" style="width:auto">
              <option value="ur" selected>اردو</option>
              <option value="en">English</option>
            </select>
          </li>
          <li class="nav-item d-flex align-items-center ms-2">
            <button id="darkModeToggle" class="btn btn-sm btn-outline-light" style="padding: 0.25rem 0.5rem; line-height: 1;">
              <!-- Moon icon -->
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-moon-fill" viewBox="0 0 16 16">
                <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.27 7.291 7.291 7.291.526 0 1.034-.063 1.518-.178.539-.111.558.611.082.858A.768.768 0 0 1 12.5 12.27a7.21 7.21 0 0 1-6.222-6.222.768.768 0 0 1 .278-.858z"/>
              </svg>
              <!-- Sun icon -->
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-sun-fill" viewBox="0 0 16 16" style="display:none;">
                <path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8M8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0m0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13m-5-4a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5M13 8a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5m-2.121 4.879a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707M4.879 4.879a.5.5 0 0 1-.707 0L2.757 3.464a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707m6.242 6.242a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707M4.879 11.121a.5.5 0 0 1-.707 0L2.757 9.707a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707"/>
              </svg>
            </button>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Announcement bar -->
  <div id="announcementBar" class="announcement-bar" role="region" aria-live="polite">
    <div class="announcement-text" id="announcementContent">Loading announcements...</div>
  </div>

  <!-- Hero -->
  <header id="home" class="hero text-center">
    <div class="container">
      <h1 id="heroTitle" class="display-5 fw-bold">Loading...</h1>
      <p id="heroSubtitle" class="lead"></p>
      <div class="mt-4">
        <a href="#courses" class="btn btn-outline-light btn-lg me-2">مزید جانیں</a>
        <a href="#contact" class="btn btn-light btn-lg text-dark">رابطہ کریں</a>
      </div>
    </div>
  </header>

  <!-- Quick Links Section -->
  <section id="quick-links" class="py-5">
    <div class="container">
      <div class="row gy-4">
        <!-- Online Donation -->
        <div class="col-lg-3 col-md-4 col-6">
          <a href="#donation" class="quick-link-card" data-link>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-wallet-fill" viewBox="0 0 16 16"><path d="M1.5 2A1.5 1.5 0 0 0 0 3.5v2h6a.5.5 0 0 1 .5.5c0 .253.08.644.306.958.207.288.557.542 1.194.542s.987-.254 1.194-.542C9.42 6.644 9.5 6.253 9.5 6a.5.5 0 0 1 .5-.5h6v-2A1.5 1.5 0 0 0 14.5 2z"/><path d="M16 6.5h-5.551a2.678 2.678 0 0 1-.443 1.042C9.613 8.088 8.806 8.5 8 8.5s-1.613-.412-2.006-.958A2.679 2.679 0 0 1 5.551 6.5H0v6A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5z"/></svg>
            <h5 id="qLinkDonation">آن لائن عطیہ</h5>
          </a>
        </div>
        <!-- Online Fatwa -->
        <div class="col-lg-3 col-md-4 col-6">
          <a href="#contact" class="quick-link-card" data-link>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-patch-question-fill" viewBox="0 0 16 16"><path d="M5.933.87a2.89 2.89 0 0 1 4.134 0l.622.622a2.89 2.89 0 0 1 0 4.134l-.622.622a2.89 2.89 0 0 1-4.134 0l-.622-.622a2.89 2.89 0 0 1 0-4.134zM8 6a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 1 0v-1A.5.5 0 0 0 8 6m0 3a1 1 0 1 0 0 2 1 1 0 0 0 0-2"/>
            <path d="m10.273 2.513-.921-.921a1.89 1.89 0 0 0-2.672 0l-.921.921c.24.18.48.4.707.658.204.23.418.48.658.707.23-.204.48-.418.707-.658.258-.226.48-.46.707-.707M11.39 8.243c.24.18.48.4.707.658.204.23.418.48.658.707.23-.204.48-.418.707-.658.258-.226.48-.46.707-.707l.921.921a1.89 1.89 0 0 1 0 2.672l-.921.921c-.24-.18-.48-.4-.707-.658a4.6 4.6 0 0 0-.658-.707c-.23.204-.48.418-.707.658-.258-.226-.48.46-.707.707l-.921-.921a1.89 1.89 0 0 1 0-2.672l.921-.921zm-6.622 0-.921.921a1.89 1.89 0 0 0 0 2.672l.921.921c.24-.18.48-.4.707-.658.204-.23.418.48.658.707.23.204.48.418.707.658.258-.226-.48.46.707.707l.921-.921a1.89 1.89 0 0 0 0-2.672l-.921-.921c-.24.18-.48.4-.707.658a4.6 4.6 0 0 0-.658.707c-.23-.204-.48-.418-.707-.658-.258-.226-.48-.46-.707-.707M4.6 2.513c-.24.18-.48.4-.707.658a4.6 4.6 0 0 0-.658.707c-.23-.204-.48-.418-.707-.658-.258-.226-.48-.46-.707-.707l-.921.921a1.89 1.89 0 0 0 0 2.672l.921.921c.24-.18.48-.4.707-.658.204-.23.418.48.658.707.23.204.48.418.707.658.258-.226-.48.46.707.707l.921-.921a1.89 1.89 0 0 0 0-2.672l-.921-.921z"/></svg>
            <h5 id="qLinkFatwa">آن لائن فتویٰ</h5>
          </a>
        </div>
        <!-- Library -->
        <div class="col-lg-3 col-md-4 col-6">
          <a href="#library" class="quick-link-card" data-link>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-book-half" viewBox="0 0 16 16"><path d="M8.5 2.687c.654-.689 1.782-.886 3.112-.752 1.234.124 2.503.523 3.388 1.17.8-.5 1.6-1.12 2.6-1.55A.5.5 0 0 0 16 1.5v2.083c-1.004.456-2.005.972-3.006 1.577-1.344.803-2.677.803-4.02.0C7.68 4.62 6.35 4.14 5.07 3.657v-2.1a.5.5 0 0 1 .43-.49C6.4 1.006 7.3 1.06 8.5 2.687M8 3.5v10.868c-1.04-.43-2.115-.793-3.182-1.043C3.73 12.9 2.5 12.5 1.5 12.5c-.822 0-1.6.2-2.3.402v-9.6C.367 3.005.86 2.5 1.5 2.5c.822 0 1.6.2 2.3.402C4.867 3.207 5.93 3.5 7 3.5z"/><path d="M5.07 3.657v11.122C4.005 14.345 3.004 13.828 2.003 13.31c-.834-.41-1.63-.48-2.3-.41V2.98C.367 3.005.86 2.5 1.5 2.5c.822 0 1.6.2 2.3.402C4.867 3.207 5.93 3.5 7 3.5a6.97 6.97 0 0 1 1-.035V3.5z"/></svg>
            <h5 id="qLinkBooks">کتب خانہ</h5>
          </a>
        </div>
        <!-- Gallery -->
        <div class="col-lg-3 col-md-4 col-6">
          <a href="#gallery" class="quick-link-card" data-link>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-images" viewBox="0 0 16 16"><path d="M4.502 9a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3"/><path d="M14.002 13a2 2 0 0 1-2 2h-10a2 2 0 0 1-2-2V5A2 2 0 0 1 2 3a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v8a2 2 0 0 1-1.998 2M14 2H4a1 1 0 0 0-1 1h9.002a2 2 0 0 1 2 2v7A1 1 0 0 0 15 11V3a1 1 0 0 0-1-1M2.002 4a1 1 0 0 0-1 1v8l2.646-2.354a.5.5 0 0 1 .63-.062l2.66 1.773 3.71-3.71a.5.5 0 0 1 .577-.094l1.777 1.947V5a1 1 0 0 0-1-1z"/></svg>
            <h5 id="qLinkGallery">گیلری</h5>
          </a>
        </div>
      </div>
    </div>
  </section>

  <main class="py-5">
    <div class="container">

      <!-- About -->
      <section id="about" class="mb-5">
        <div class="section-title mb-3">
          <h2 style="margin:0" id="aboutHeading">ہمارے بارے میں</h2>
        </div>
        <div class="row">
          <div class="col-lg-6">
            <p id="aboutText">Loading about info...</p>
          </div>
          <div class="col-lg-6">
            <img src="https://images.unsplash.com/photo-1542736667-069246bdbc6d?q=80&w=1600&auto=format&fit=crop&ixlib=rb-4.0.3&s=" alt="Madrasa" class="img-fluid rounded" id="aboutImage">
          </div>
        </div>
      </section>

      <!-- Courses -->
      <section id="courses" class="mb-5">
        <div class="section-title mb-3">
          <h2 id="coursesHeading">کورسز</h2>
        </div>
        <div id="coursesList" class="row gy-3">
          <!-- Course cards injected here from Firebase -->
          <p>Loading courses...</p>
        </div>
      </section>

      <!-- Events -->
      <section id="events" class="mb-5">
        <div class="section-title mb-3">
          <h2 id="eventsHeading">تقریبات</h2>
        </div>
        <div id="eventsList" class="row gy-4">
          <!-- Events injected here from Firebase -->
          <p>Loading events...</p>
        </div>
      </section>

      <!-- Gallery -->
      <section id="gallery" class="mb-5">
        <div class="section-title mb-3">
          <h2 id="galleryHeading">گیلری</h2>
        </div>
        <div id="galleryGrid" class="gallery-grid">
          <!-- images injected here from Firebase -->
          <p>Loading gallery...</p>
        </div>
      </section>

      <!-- Custom Sections -->
      <section id="customSections" class="mb-5">
        <div id="customSectionsList" class="container">
          <!-- Custom sections injected here -->
          <p>Loading sections...</p>
        </div>
      </section>

      <!-- Library Section -->
      <section id="library" class="mb-5">
        <div class="section-title mb-3">
          <h2 id="libraryHeading">کتب خانہ</h2>
        </div>
        <div class="card text-center p-4" style="background-color: var(--card-bg);">
          <div class="card-body">
            <h5 class="card-title" id="libraryCardTitle">Darul Uloom Deoband - Online Books</h5>
            <p class="card-text" id="libraryCardText">The requested library cannot be embedded directly on this page due to security restrictions. You can access the full library by clicking the button below.</p>
            <a href="http://darululoom-deoband.com/books/" id="libraryCardButton" class="btn btn-primary" target="_blank" rel="noopener noreferrer">Visit Library</a>
          </div>
        </div>
      </section>

      <!-- Donation Section -->
      <section id="donation" class="mb-5">
        <div class="section-title mb-3">
          <h2 id="donationHeading">عطیہ فارم</h2>
        </div>
        <div class="row">
          <div class="col-lg-8">
            <form id="donationForm">
              <div class="row">
                <!-- Donation Amount -->
                <div class="col-md-6 mb-3">
                  <label for="donationAmount" class="form-label" id="lblDonationAmount">Donation Amount (Indian Rupees)</label>
                  <input type="number" class="form-control" id="donationAmount" placeholder="Enter numeric value" required>
                </div>
                <!-- Donation Type -->
                <div class="col-md-6 mb-3">
                  <label for="donationType" class="form-label" id="lblDonationType">Donation Type</label>
                  <select class="form-select" id="donationType">
                    <option value="General" id="optDonationGeneral">General Donation</option>
                    <option value="Zakat" id="optDonationZakat">Zakat</option>
                    <option value="Sadqa" id="optDonationSadqa">Sadqa</option>
                    <option value="Construction" id="optDonationConstruction">Construction</option>
                    <option value="Other" id="optDonationOther">Other</option>
                  </select>
                </div>
                <!-- Other Donation Type (Hidden by default) -->
                <div class="col-md-12 mb-3" id="otherDonationTypeContainer" style="display: none;">
                  <label for="otherDonationType" class="form-label" id="lblOtherDonationType">Other Donation Type</label>
                  <input type="text" class="form-control" id="otherDonationType" placeholder="Specify, if other donation type">
                </div>
                <!-- Name -->
                <div class="col-md-6 mb-3">
                  <label for="donationName" class="form-label" id="lblDonationName">Name</label>
                  <input type="text" class="form-control" id="donationName" placeholder="Enter Full Name" required>
                </div>
                <!-- Phone -->
                <div class="col-md-6 mb-3">
                  <label for="donationPhone" class="form-label" id="lblDonationPhone">Mobile / Phone No.</label>
                  <input type="tel" class="form-control" id="donationPhone" placeholder="10 digits only" pattern="[0-9]{10}" required>
                </div>
                <!-- Address -->
                <div class="col-12 mb-3">
                  <label for="donationAddress" class="form-label" id="lblDonationAddress">Complete Address</label>
                  <textarea class="form-control" id="donationAddress" rows="3" placeholder="Including Pin within India" required></textarea>
                </div>
                <!-- Email -->
                <div class="col-md-6 mb-3">
                  <label for="donationEmail" class="form-label" id="lblDonationEmail">Email ID</label>
                  <input type="email" class="form-control" id="donationEmail" placeholder="Valid Email Address" required>
                </div>
                <!-- Document ID -->
                <div class="col-md-6 mb-3">
                  <label for="donationDocId" class="form-label" id="lblDonationDocId">Document ID (Aadhaar/PAN) No.</label>
                  <input type="text" class="form-control" id="donationDocId" placeholder="Valid Document No." required>
                </div>
              </div>
              <button class="btn btn-success btn-lg" type="submit" id="donationSubmit">Donate Now</button>
            </form>
          </div>
          <div class="col-lg-4">
            <!-- Payment Info Container -->
            <div id="donationPaymentInfo" class="text-center p-3 rounded" style="background-color: var(--card-bg); border: 1px solid #ddd; display: none;">
              <h5 id="donationPaymentTitle">Complete Your Donation</h5>
              <p id="donationPaymentSubtitle">Please support us by donating via UPI.</p>
              <img id="donationQR" src="" alt="UPI QR Code" class="img-fluid rounded mb-3" style="max-width: 200px;">
              <div class="input-group mb-3">
                <input type="text" id="upiIdInput" class="form-control" value="loading..." readonly>
                <button class="btn btn-outline-secondary" type="button" id="copyUpiButton">
                  <span id="copyUpiBtnText">Copy</span>
                </button>
              </div>
              <a id="payNowLink" href="#" class="btn btn-primary" target="_blank">
                <span id="payNowBtnText">Pay Now</span>
              </a>
            </div>
          </div>
        </div>
      </section>

      <!-- Contact -->
      <section id="contact" class="mb-5">
        <div class="section-title mb-3">
          <h2 id="contactHeading">رابطہ کریں</h2>
        </div>
        <div class="row">
          <div class="col-lg-6">
            <form id="contactForm">
              <div class="mb-3">
                <label class="form-label" id="lblName">نام</label>
                <input type="text" class="form-control" id="contactName" required>
              </div>
              <div class="mb-3">
                <label class="form-label" id="lblEmail">ای میل</label>
                <input type="email" class="form-control" id="contactEmail" required>
              </div>
              <div class="mb-3">
                <label class="form-label" id="lblSubject">موضوع</label>
                <input type="text" class="form-control" id="contactSubject">
              </div>
              <div class="mb-3">
                <label class="form-label" id="lblMessage">پیغام</label>
                <textarea class="form-control" id="contactMessage" rows="4" required></textarea>
              </div>
              <button class="btn btn-success" type="submit" id="contactSubmit">ارسال</button>
            </form>
          </div>
          <!-- Updated Contact Info with LTR fixes -->
          <div class="col-lg-6">
            <h5 id="contactInfoHeading">رابطہ کی معلومات</h5>
            <p id="contactInfo" style="line-height: 1.8;">
              <strong id="lblAddress">پتہ:</strong> <span dir="ltr">H.no: 9, 4-134/5/A/1/1, Raghava Colony, Nadeem Colony, Vali Colony, Toli Chowki, Hyderabad, Telangana 500008</span><br>
              <strong id="lblPhone">فون:</strong> <span dir="ltr"><a href="tel:0905843885" class="text-dark" style="text-decoration:none;">090584 3885</a></span><br>
              <strong id="lblContactEmail">ای میل:</strong> <span dir="ltr"><a href="mailto:madrasadaruttaleemwattarbiyah@gmail.com" class="text-dark" style="text-decoration:none;">madrasadaruttaleemwattarbiyah@gmail.com</a></span><br>
              <strong id="lblMap">نقشہ:</strong> <a id="linkMap" href="https://maps.app.goo.gl/X85qiTVBdRNCRn8X7" target="_blank" rel="noopener noreferrer">گوگل میپس پر دیکھیں</a>
            </p>
          </div>
        </div>
      </section>

    </div>
  </main>

  <!-- Footer -->
  <footer class="footer text-center text-white">
    <div class="container">
      <div class="row">
        <div class="col-md-6 text-md-end">
          <p style="margin:0">© <span id="year"></span> دارالتعلیم والتربیہ</p>
        </div>
        <div class="col-md-6 text-md-start">
          <small>Follow us: <a href="#" class="text-white">Facebook</a> | <a href="#" class="text-white">Instagram</a></small>
        </div>
      </div>
    </div>
  </footer>

  <!-- Admin Modal / Panel (single-page simulated) -->
  <div class="modal fade" id="adminModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ایڈمن پینل</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">

          <!-- Login view -->
          <div id="adminLoginView">
            <form id="adminLoginForm">
              <div class="mb-3">
                <label>Email (e.g., admin@madrasa.com)</label>
                <input class="form-control" id="adminUser" value="">
              </div>
              <div class="mb-3">
                <label>Password</label>
                <input class="form-control" id="adminPass" type="password" value="">
              </div>
              <button class="btn btn-primary">Login</button>
            </form>
          </div>

          <!-- Panel view -->
          <div id="adminPanelView" style="display:none">
            <div class="row admin-panel">
              <div class="col-lg-4">
                <div class="list-group mb-3">
                  <button class="list-group-item list-group-item-action active" data-panel="ann">Announcements</button>
                  <button class="list-group-item list-group-item-action" data-panel="home">Homepage (Hero)</button>
                  <button class="list-group-item list-group-item-action" data-panel="about">About Us</button>
                  <button class="list-group-item list-group-item-action" data-panel="courses">Courses</button>
                  <button class="list-group-item list-group-item-action" data-panel="events">Events</button>
                  <button class="list-group-item list-group-item-action" data-panel="gallery">Gallery</button>
                  <button class="list-group-item list-group-item-action" data-panel="sections">Custom Sections</button>
                  <button class="list-group-item list-group-item-action" data-panel="logo">Logo</button>
                  <button class="list-group-item list-group-item-action" data-panel="donationSettings">Donation Settings</button>
                  <button class="list-group-item list-group-item-action" data-panel="messages">Messages</button>
                  <button class="list-group-item list-group-item-action" data-panel="donations" id="adminNavDonations">Donations</button>
                </div>

                <div>
                  <button id="adminLogout" class="btn btn-outline-danger btn-sm">Logout</button>
                </div>
              </div>

              <div class="col-lg-8">
                <div id="panelContent">
                  <!-- dynamic admin content injected here -->
                </div>
              </div>
            </div>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بند کریں</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Custom Toast Notification -->
  <div id="customToast" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
    <div class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div id="toastBody" class="toast-body">
          Message sent successfully.
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>


  <!-- Bootstrap + Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- 
    ******************************************************************
    ** FIREBASE SCRIPT - THIS IS THE NEW MODULAR SDK SCRIPT **
    ******************************************************************
  -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-analytics.js";
    // Import Firestore (Database)
    import { 
      getFirestore, collection, getDocs, addDoc, 
      deleteDoc, doc, query, onSnapshot, orderBy,
      setDoc, getDoc
    } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
    // Import Auth (Login)
    import { 
      getAuth, signInWithEmailAndPassword, 
      onAuthStateChanged, signOut 
    } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    // *** We are NO LONGER importing Firebase Storage ***

    // YOUR FIREBASE CONFIG (from the code you provided)
    const firebaseConfig = {
      apiKey: "AIzaSyANp3lRfm2eruX3Y3M9_T5GIyfN6bRp0j8",
      authDomain: "madrasa-website-12926.firebaseapp.com",
      projectId: "madrasa-website-12926",
      storageBucket: "madrasa-website-12926.firebasestorage.app",
      messagingSenderId: "202677366743",
      appId: "1:202677366743:web:41109ec3d872be8472a592",
      measurementId: "G-N1Y5J2ELS4"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    
    // Initialize Firebase Services
    const db = getFirestore(app);
    const auth = getAuth(app);
    // *** No need to initialize storage ***

    // ----------------- i18n content -----------------
    const i18n = {
      ur: {
        brandTitle: 'دارالتعلیم والتربیہ',
        brandSubtitle: 'Darut Taleem Wat Tarbiyah',
        navHome: 'صفحہ اول',
        navAbout: 'ہمارے بارے میں',
        navCourses: 'کورسز',
        navEvents: 'تقریبات',
        navGallery: 'گیلری',
        navSections: 'شعبے',
        navLibrary: 'کتب خانہ',
        navDonation: 'عطیہ',
        navContact: 'رابطہ کریں',
        navAdmin: 'ایڈمن',
        qLinkDonation: 'آن لائن عطیہ',
        qLinkFatwa: 'آن لائن فتویٰ',
        qLinkBooks: 'کتب خانہ',
        qLinkGallery: 'گیلری',
        aboutHeading: 'ہمارے بارے میں',
        coursesHeading: 'کورسز',
        eventsHeading: 'تقریبات',
        galleryHeading: 'گیلری',
        contactHeading: 'رابطہ کریں',
        lblName: 'نام', lblEmail: 'ای میل', lblSubject: 'موضوع', lblMessage: 'پیغام', contactSubmit: 'ارسال', contactInfoHeading: 'رابطہ کی معلومات',
        lblAddress: 'پتہ:',
        lblPhone: 'فون:',
        lblContactEmail: 'ای میل:',
        lblMap: 'نقشہ:',
        linkMap: 'گوگل میپس پر دیکھیں',
        libraryHeading: 'کتب خانہ',
        libraryCardTitle: 'دارالعلوم دیوبند - آن لائن کتب',
        libraryCardText: 'درخواست کردہ کتب خانہ کو سیکورٹی پابندیوں کی وجہ سے براہ راست اس صفحہ پر نہیں دکھایا جا سکتا۔ آپ نیچے دیے گئے بٹن پر کلک کر کے مکمل کتب خانہ تک رسائی حاصل کر سکتے ہیں۔',
        libraryCardButton: 'کتب خانہ پر جائیں',
        contactFormNote: 'نوٹ: پیغامات کو ایڈمن پینل میں محفوظ کیا جاتا ہے۔',
        donationHeading: 'عطیہ فارم',
        lblDonationAmount: 'رقمِ عطیہ (ہندوستانی روپیے)',
        lblDonationType: 'عطیہ کی قسم',
        optDonationGeneral: 'عام عطیہ',
        optDonationZakat: 'زکوٰۃ',
        optDonationSadqa: 'صدقہ',
        optDonationConstruction: 'تعمیر',
        optDonationOther: 'دیگر',
        lblOtherDonationType: 'دیگر عطیہ کی قسم',
        lblDonationName: 'نام',
        lblDonationPhone: 'موبائل / فون نمبر',
        lblDonationAddress: 'مکمل پتہ',
        lblDonationEmail: 'ای میل آئی ڈی',
        lblDonationDocId: 'دستاویز آئی ڈی (آدھار/پین) نمبر',
        donationSubmit: 'ابھی عطیہ دیں',
        donationPaymentTitle: 'اپنا عطیہ مکمل کریں۔',
        donationPaymentSubtitle: 'برائے مہربانی UPI کے ذریعے عطیہ دے کر ہماری مدد کریں۔',
        copyUpiBtnText: 'کاپی',
        payNowBtnText: 'ابھی ادا کریں۔',
        copiedToast: 'UPI ID کاپی ہو گیا!',
        adminLogo: 'لوگو',
        adminDonations: 'عطیات'
      },
      en: {
        brandTitle: 'Darut Taleem Wat Tarbiyah',
        brandSubtitle: 'Knowledge and Upbringing',
        navHome: 'Home',
        navAbout: 'About Us',
        navCourses: 'Courses',
        navEvents: 'Events',
        navGallery: 'Gallery',
        navSections: 'Sections',
        navLibrary: 'Library',
        navDonation: 'Donation',
        navContact: 'Contact Us',
        navAdmin: 'Admin',
        qLinkDonation: 'Online Donation',
        qLinkFatwa: 'Online Fatwa',
        qLinkBooks: 'Library',
        qLinkGallery: 'Gallery',
        aboutHeading: 'About Us',
        coursesHeading: 'Courses',
        eventsHeading: 'Events',
        galleryHeading: 'Gallery',
        contactHeading: 'Contact Us',
        lblName: 'Name', lblEmail: 'Email', lblSubject: 'Subject', lblMessage: 'Message', contactSubmit: 'Send', contactInfoHeading: 'Contact Information',
        lblAddress: 'Address:',
        lblPhone: 'Phone:',
        lblContactEmail: 'Email:',
        lblMap: 'Map:',
        linkMap: 'View on Google Maps',
        libraryHeading: 'Library',
        libraryCardTitle: 'Darul Uloom Deoband - Online Books',
        libraryCardText: 'The requested library cannot be embedded directly on this page due to security restrictions. You can access the full library by clicking the button below.',
        libraryCardButton: 'Visit Library',
        contactFormNote: 'Note: Messages are saved to the Admin Panel.',
        donationHeading: 'Donation Form',
        lblDonationAmount: 'Donation Amount (Indian Rupees)',
        lblDonationType: 'Donation Type',
        optDonationGeneral: 'General Donation',
        optDonationZakat: 'Zakat',
        optDonationSadqa: 'Sadqa',
        optDonationConstruction: 'Construction',
        optDonationOther: 'Other',
        lblOtherDonationType: 'Other Donation Type',
        lblDonationName: 'Name',
        lblDonationPhone: 'Mobile / Phone No.',
        lblDonationAddress: 'Complete Address',
        lblDonationEmail: 'Email ID',
        lblDonationDocId: 'Document ID (Aadhaar/PAN) No.',
        donationSubmit: 'Donate Now',
        donationPaymentTitle: 'Complete Your Donation',
        donationPaymentSubtitle: 'Please support us by donating via UPI.',
        copyUpiBtnText: 'Copy',
        payNowBtnText: 'Pay Now',
        copiedToast: 'UPI ID Copied!',
        adminLogo: 'Logo',
        adminDonations: 'Donations'
      }
    };

    // ----------------- NEW HELPER FUNCTION -----------------
    /**
     * Converts a File object to a base64 data URL.
     * @param {File} file The file to convert.
     * @returns {Promise<string>} A promise that resolves with the base64 string.
     */
    function toBase64(file) {
      return new Promise((resolve, reject) => {
        // Check file size (1 MiB limit for Firestore docs, base64 is ~33% larger)
        if (file.size > 750 * 1024) { // ~750KB limit
           reject(new Error('File is too large. Please use images under 750KB.'));
           return;
        }
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
      });
    }

    // ----------------- DOM helpers (unchanged) -----------------
    const setYear = ()=> document.getElementById('year').textContent = new Date().getFullYear()
    setYear()

    // ----------------- Toast Notification Helper (unchanged) -----------------
    const customToastEl = document.getElementById('customToast')
    const customToast = new bootstrap.Toast(customToastEl.querySelector('.toast'))
    const toastBody = document.getElementById('toastBody')
    const toastEl = customToastEl.querySelector('.toast')

    function showToast(message, type = 'success') {
        toastBody.textContent = message
        
        toastEl.classList.remove('bg-success', 'bg-danger')
        if (type === 'danger') {
            toastEl.classList.add('bg-danger')
        } else {
            toastEl.classList.add('bg-success')
        }
        
        customToast.show()
    }

    // ----------------- FIREBASE DATA RENDERING -----------------
    
    let homeData = {};
    let aboutData = {};
    let eventsData = [];
    let sectionsData = [];
    let currentLang = 'ur'; 

    // Render Logo (using base64 string)
    function renderLogo() {
      const logoRef = doc(db, "siteConfig", "logo");
      const logoContainer = document.getElementById('navbarLogoContainer');
      const fallbackLogo = `
        <div class="fallback-logo">
          <span style="font-weight:700; color:var(--primary)">د</span>
        </div>`;

      onSnapshot(logoRef, (doc) => {
        if (doc.exists() && doc.data().logoData) {
          logoContainer.innerHTML = `<img src="${doc.data().logoData}" alt="Logo" id="navbarLogo" style="margin-inline-start:.6rem">`;
        } else {
          logoContainer.innerHTML = fallbackLogo;
        }
      }, (error) => {
        console.error("Error fetching logo: ", error);
        logoContainer.innerHTML = fallbackLogo;
      });
    }
    renderLogo();

    // Render Homepage Hero
    function renderHomepage() {
      const heroTitleEl = document.getElementById('heroTitle');
      const heroSubtitleEl = document.getElementById('heroSubtitle');

      onSnapshot(doc(db, "siteConfig", "homepage"), (doc) => {
        if (doc.exists()) {
          homeData = doc.data(); 
          applyLanguage(currentLang); 
        } else {
          heroTitleEl.textContent = "Welcome";
          heroSubtitleEl.textContent = "Please set homepage text in admin panel";
        }
      }, (error) => { console.error("Error fetching homepage data: ", error); });
    }
    renderHomepage();

    // Render About Us (with base64 image)
    function renderAbout() {
      const aboutTextEl = document.getElementById('aboutText');
      const aboutImageEl = document.getElementById('aboutImage');

      onSnapshot(doc(db, "siteConfig", "about"), (doc) => {
        if (doc.exists()) {
          aboutData = doc.data(); 
          if (aboutData.imageData) { // Use imageData field
            aboutImageEl.src = aboutData.imageData;
          }
          applyLanguage(currentLang); 
        } else {
          aboutTextEl.textContent = "Please set about text in admin panel";
        }
      }, (error) => { console.error("Error fetching about data: ", error); });
    }
    renderAbout();

    // Render announcements (real-time)
    function renderAnnouncements(){
      const annRef = collection(db, "announcements");
      const q = query(annRef, orderBy("createdAt", "desc"));
      
      onSnapshot(q, (snapshot) => {
        const anns = [];
        snapshot.forEach(doc => anns.push(doc.data()));
        
        const bar = document.getElementById('announcementContent');
        if(anns.length === 0){ bar.textContent = 'Welcome' ; return }

        const text = anns.map(a=>a.text).join('   •   ');
        bar.textContent = text + '   •   ' + text + '   •   ' + text;
      }, (error) => {
        console.error("Error fetching announcements: ", error);
        document.getElementById('announcementContent').textContent = "Error loading announcements.";
      });
    }
    renderAnnouncements();


    // Render courses (fetch once)
    async function renderCourses(){
      const container = document.getElementById('coursesList');
      container.innerHTML = '<p>Loading courses...</p>';
      
      try {
        const snapshot = await getDocs(collection(db, "courses"));
        container.innerHTML = ''; 
        
        if (snapshot.empty) {
          container.innerHTML = '<p>No courses listed yet.</p>';
          return;
        }
        
        snapshot.forEach(doc => {
          const c = doc.data();
          const col = document.createElement('div'); col.className = 'col-md-6 col-lg-4';
          col.innerHTML = `
            <div class="card card-course h-100">
              <div class="card-body">
                <h5 class="card-title">${c.titleUr || c.titleEn}</h5>
                <p class="card-text">${c.descUr || c.descEn}</p>
              </div>
              <div class="card-footer small text-muted">${c.duration || ''}</div>
            </div>
          `;
          container.appendChild(col);
        });
      } catch (error) {
        console.error("Error fetching courses: ", error);
        container.innerHTML = '<p>Error loading courses.</p>';
      }
    }
    renderCourses();

    // Render Events (real-time)
    function renderEvents() {
      const q = query(collection(db, "events"), orderBy("createdAt", "desc"));

      onSnapshot(q, (snapshot) => {
        const container = document.getElementById('eventsList');
        container.innerHTML = '';
        eventsData = []; // Clear cache

        if (snapshot.empty) {
          container.innerHTML = '<p>No events listed yet.</p>';
          return;
        }

        snapshot.forEach(doc => {
          eventsData.push(doc.data()); // Cache data
        });
        
        applyLanguage(currentLang); // Re-apply language to render
        
      }, (error) => {
        console.error("Error fetching events: ", error);
        document.getElementById('eventsList').innerHTML = '<p>Error loading events.</p>';
      });
    }
    renderEvents();

    // Render gallery (fetch once)
    async function renderGallery(){
      const grid = document.getElementById('galleryGrid');
      grid.innerHTML = '<p>Loading gallery...</p>';
      
      try {
        const snapshot = await getDocs(collection(db, "gallery"));
        grid.innerHTML = '';
        
        if (snapshot.empty) {
          grid.innerHTML = '<p>No gallery images yet.</p>';
          return;
        }
        
        snapshot.forEach(doc => {
          const img = doc.data();
          const imgEl = document.createElement('img');
          imgEl.src = img.imageData; // Use imageData field
          imgEl.alt = img.name || 'Gallery';
          grid.appendChild(imgEl);
        });
      } catch (error) {
        console.error("Error fetching gallery: ", error);
        grid.innerHTML = '<p>Error loading gallery.</p>';
      }
    }
    renderGallery();

    // Render Custom Sections (real-time)
    function renderCustomSections() {
      const q = query(collection(db, "customSections"), orderBy("createdAt", "desc"));

      onSnapshot(q, (snapshot) => {
        const container = document.getElementById('customSectionsList');
        container.innerHTML = '';
        sectionsData = []; // Clear cache

        if (snapshot.empty) {
          container.innerHTML = '<p>No sections added yet.</p>';
          return;
        }

        snapshot.forEach(doc => {
          sectionsData.push(doc.data()); // Cache data
        });

        applyLanguage(currentLang); // Re-apply language to render

      }, (error) => {
        console.error("Error fetching custom sections: ", error);
        document.getElementById('customSectionsList').innerHTML = '<p>Error loading sections.</p>';
      });
    }
    renderCustomSections();

    // Contact form submission
    document.getElementById('contactForm').addEventListener('submit', async function(e){
      e.preventDefault();
      const form = this;
      const submitButton = form.querySelector('button[type="submit"]');
      submitButton.disabled = true;
      submitButton.innerText = "Sending...";

      try {
        const msg = {
          name: document.getElementById('contactName').value.trim(),
          email: document.getElementById('contactEmail').value.trim(),
          subject: document.getElementById('contactSubject').value.trim(),
          message: document.getElementById('contactMessage').value.trim(),
          createdAt: new Date()
        };
        
        await addDoc(collection(db, "messages"), msg);
        
        form.reset();
        showToast('پیغام موصول ہوگیا — ہم جلد رابطہ کریں گے', 'success');
      } catch (error) {
        console.error("Error saving message: ", error);
        showToast('Error sending message.', 'danger');
      } finally {
        submitButton.disabled = false;
        submitButton.innerText = i18n[langSelect.value].contactSubmit;
      }
    });

    // ----------------- Donation Form Logic -----------------
    const donationTypeSelect = document.getElementById('donationType');
    const otherDonationTypeContainer = document.getElementById('otherDonationTypeContainer');
    
    donationTypeSelect.addEventListener('change', function() {
      otherDonationTypeContainer.style.display = (this.value === 'Other') ? 'block' : 'none';
    });
    
    document.getElementById('donationForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const submitButton = this.querySelector('button[type="submit"]');
      submitButton.disabled = true;
      
      let donationType = donationTypeSelect.value;
      if (donationType === 'Other') {
        donationType = document.getElementById('otherDonationType').value.trim() || 'Other';
      }

      const donation = {
        amount: document.getElementById('donationAmount').value,
        type: donationType,
        name: document.getElementById('donationName').value.trim(),
        phone: document.getElementById('donationPhone').value.trim(),
        address: document.getElementById('donationAddress').value.trim(),
        email: document.getElementById('donationEmail').value.trim(),
        docId: document.getElementById('donationDocId').value.trim(),
        createdAt: new Date()
      };
      
      try {
        await addDoc(collection(db, "donations"), donation);
        
        document.getElementById('donationPaymentInfo').style.display = 'block';
        showToast('Form submitted. Please complete the payment.', 'success');
        
      } catch (error) {
        console.error("Error saving donation: ", error);
        showToast('Error submitting form. Please try again.', 'danger');
      } finally {
        submitButton.disabled = false;
      }
    });

    // ----------------- Admin interactions (Base64) -----------------
    const adminModal = new bootstrap.Modal(document.getElementById('adminModal'));
    document.getElementById('openAdmin').addEventListener('click',()=>{ adminModal.show() });

    // Admin Login
    document.getElementById('adminLoginForm').addEventListener('submit', async function(e){
      e.preventDefault();
      const email = document.getElementById('adminUser').value;
      const pass = document.getElementById('adminPass').value;
      
      try {
        await signInWithEmailAndPassword(auth, email, pass);
        showToast('Login successful!', 'success');
      } catch (error) {
        console.error("Login failed:", error.message);
        showToast(error.message, 'danger');
      }
    });

    // Admin Logout
    document.getElementById('adminLogout').addEventListener('click', ()=>{
      signOut(auth);
      showToast('Logged out', 'success');
    });

    // Auth State Listener
    onAuthStateChanged(auth, user => {
      if (user) {
        document.getElementById('adminLoginView').style.display = 'none';
        document.getElementById('adminPanelView').style.display = 'block';
        loadAdminPanel('ann'); 
      } else {
        document.getElementById('adminLoginView').style.display = 'block';
        document.getElementById('adminPanelView').style.display = 'none';
      }
    });

    // Panel nav buttons
    document.querySelectorAll('[data-panel]').forEach(btn=> btn.addEventListener('click', ()=> loadAdminPanel(btn.dataset.panel) ))

    // Admin Panel Loader
    async function loadAdminPanel(panel){
      const content = document.getElementById('panelContent');
      content.innerHTML = '<h5>Loading...</h5>';
      
      document.querySelectorAll('[data-panel]').forEach(b => {
        b.classList.toggle('active', b.dataset.panel === panel);
      });

      // --- Announcements Panel ---
      if(panel === 'ann'){
        content.innerHTML = `
          <h5>Announcements</h5>
          <form id="annForm" class="mb-3">
            <div class="mb-2"><textarea id="annText" class="form-control" rows="2" placeholder="Add announcement in Urdu or English" required></textarea></div>
            <button class="btn btn-success btn-sm">Add</button>
          </form>
          <div id="annsList"></div>
        `;
        
        document.getElementById('annForm').addEventListener('submit', async function(e){
          e.preventDefault(); 
          const text = document.getElementById('annText').value.trim(); 
          if(!text) return;
          try {
            await addDoc(collection(db, "announcements"), { text: text, createdAt: new Date() });
            showToast('Announcement added', 'success');
            this.reset();
          } catch(error) { showToast(error.message, 'danger'); }
        });

        const listDiv = document.getElementById('annsList');
        const annRef = collection(db, "announcements");
        onSnapshot(annRef, (snapshot) => {
          listDiv.innerHTML = '';
          if (snapshot.empty) listDiv.innerHTML = '<p>No announcements yet.</p>';
          
          snapshot.forEach(snapshotDoc => {
            const a = snapshotDoc.data();
            const el = document.createElement('div'); el.className='card mb-2 p-2'; el.innerHTML = `
              <div class="d-flex justify-content-between align-items-center">
                <div>${a.text}</div>
                <div><button class="btn btn-sm btn-danger" data-id="${snapshotDoc.id}">Delete</button></div>
              </div>
            `;
            listDiv.appendChild(el);
            
            el.querySelector('button').addEventListener('click', async (e)=>{
              const id = e.target.dataset.id;
              if (confirm('Are you sure you want to delete this?')) {
                try {
                  await deleteDoc(doc(db, "announcements", id));
                  showToast('Deleted', 'success');
                } catch(error) { showToast(error.message, 'danger'); }
              }
            });
          });
        });
      }

      // --- Homepage (Hero) Panel ---
      if(panel === 'home'){
        content.innerHTML = `
          <h5>Edit Homepage (Hero)</h5>
          <form id="homeForm" class="mb-3">
            <div class="mb-2">
              <label class="form-label">Title (Urdu)</label>
              <input id="heroTitleUr" class="form-control" dir="rtl">
            </div>
            <div class="mb-2">
              <label class="form-label">Title (English)</label>
              <input id="heroTitleEn" class="form-control">
            </div>
            <hr>
            <div class="mb-2">
              <label class="form-label">Subtitle (Urdu)</label>
              <input id="heroSubtitleUr" class="form-control" dir="rtl">
            </div>
            <div class="mb-2">
              <label class="form-label">Subtitle (English)</label>
              <input id="heroSubtitleEn" class="form-control">
            </div>
            <button class="btn btn-success btn-sm">Save Homepage</button>
          </form>
        `;

        const docRef = doc(db, "siteConfig", "homepage");
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          const data = docSnap.data();
          document.getElementById('heroTitleUr').value = data.heroTitleUr || '';
          document.getElementById('heroTitleEn').value = data.heroTitleEn || '';
          document.getElementById('heroSubtitleUr').value = data.heroSubtitleUr || '';
          document.getElementById('heroSubtitleEn').value = data.heroSubtitleEn || '';
        }

        document.getElementById('homeForm').addEventListener('submit', async function(e){
          e.preventDefault();
          const data = {
            heroTitleUr: document.getElementById('heroTitleUr').value,
            heroTitleEn: document.getElementById('heroTitleEn').value,
            heroSubtitleUr: document.getElementById('heroSubtitleUr').value,
            heroSubtitleEn: document.getElementById('heroSubtitleEn').value
          };
          try {
            await setDoc(docRef, data);
            showToast('Homepage updated!', 'success');
          } catch(error) { showToast(error.message, 'danger'); }
        });
      }

      // --- About Us Panel (Base64) ---
      if(panel === 'about'){
        content.innerHTML = `
          <h5>Edit About Us</h5>
          <form id="aboutForm" class="mb-3">
            <div class="mb-2">
              <label class="form-label">About Text (Urdu)</label>
              <textarea id="aboutTextUr" class="form-control" dir="rtl" rows="5"></textarea>
            </div>
            <div class="mb-2">
              <label class="form-label">About Text (English)</label>
              <textarea id="aboutTextEn" class="form-control" rows="5"></textarea>
            </div>
            <div class="mb-2">
              <label class="form-label">Upload Image (Replaces old one)</label>
              <input id="aboutImageFile" type="file" accept="image/*" class="form-control">
              <small>Max 750KB. Leave blank to keep current image.</small>
            </div>
            <button class="btn btn-success btn-sm">Save About Us</button>
          </form>
        `;

        const docRef = doc(db, "siteConfig", "about");
        const docSnap = await getDoc(docRef);
        let existingImageData = '';
        if (docSnap.exists()) {
          const data = docSnap.data();
          document.getElementById('aboutTextUr').value = data.aboutTextUr || '';
          document.getElementById('aboutTextEn').value = data.aboutTextEn || '';
          existingImageData = data.imageData || '';
        }

        document.getElementById('aboutForm').addEventListener('submit', async function(e){
          e.preventDefault();
          const submitButton = this.querySelector('button');
          submitButton.disabled = true;
          submitButton.innerText = "Saving...";
          
          const file = document.getElementById('aboutImageFile').files[0];
          let newImageData = existingImageData;

          try {
            if (file) {
              newImageData = await toBase64(file);
            }
            
            const data = {
              aboutTextUr: document.getElementById('aboutTextUr').value,
              aboutTextEn: document.getElementById('aboutTextEn').value,
              imageData: newImageData
            };
            
            await setDoc(docRef, data);
            showToast('About Us updated!', 'success');
          } catch(error) {
            showToast(error.message, 'danger');
          } finally {
            submitButton.disabled = false;
            submitButton.innerText = "Save About Us";
          }
        });
      }

      // --- Courses Panel ---
      if(panel === 'courses'){
        content.innerHTML = `
          <h5>Courses</h5>
          <form id="courseForm" class="mb-3">
            <div class="row g-2">
              <div class="col-md-6"><input id="courseTitleUr" class="form-control" placeholder="Title (Urdu)"></div>
              <div class="col-md-6"><input id="courseTitleEn" class="form-control" placeholder="Title (English)"></div>
            </div>
            <div class="row g-2 mt-2">
              <div class="col-md-6"><input id="courseDuration" class="form-control" placeholder="Duration"></div>
              <div class="col-md-6"><input id="courseDescEn" class="form-control" placeholder="Short description (English)"></div>
            </div>
            <div class="mt-2"><textarea id="courseDescUr" class="form-control" placeholder="Short description (Urdu)"></textarea></div>
            <div class="mt-2"><button class="btn btn-success btn-sm">Add Course</button></div>
          </form>
          <div id="coursesListAdmin"></div>
        `;
        
        document.getElementById('courseForm').addEventListener('submit', async function(e){
          e.preventDefault();
          const obj = {
            titleUr: document.getElementById('courseTitleUr').value || '',
            titleEn: document.getElementById('courseTitleEn').value || '',
            descUr: document.getElementById('courseDescUr').value || '',
            descEn: document.getElementById('courseDescEn').value || '',
            duration: document.getElementById('courseDuration').value || ''
          };
          try {
            await addDoc(collection(db, "courses"), obj);
            showToast('Course added', 'success');
            renderCourses();
            loadAdminPanel('courses');
          } catch(error) { showToast(error.message, 'danger'); }
        });

        const out = document.getElementById('coursesListAdmin');
        const courseSnapshot = await getDocs(collection(db, "courses"));
        if (courseSnapshot.empty) out.innerHTML = '<p>No courses yet.</p>';
        courseSnapshot.forEach(snapshotDoc => {
          const c = snapshotDoc.data();
          const el = document.createElement('div'); el.className='card mb-2 p-2';
          el.innerHTML = `<div class="d-flex justify-content-between align-items-start"><div><strong>${c.titleUr||c.titleEn}</strong><div class="small text-muted">${c.duration||''}</div></div><div><button class="btn btn-sm btn-danger" data-id="${snapshotDoc.id}">Delete</button></div></div>`;
          out.appendChild(el);
          el.querySelector('button').addEventListener('click', async (e)=>{
            const id = e.target.dataset.id;
            if (confirm('Are you sure you want to delete this?')) {
              await deleteDoc(doc(db, "courses", id));
              renderCourses();
              loadAdminPanel('courses');
            }
          });
        });
      }

      // --- Events Panel ---
      if (panel === 'events') {
        content.innerHTML = `
          <h5>Events</h5>
          <form id="eventForm" class="mb-3">
            <div class="mb-2"><input id="eventTitleUr" class="form-control" placeholder="Event Title (Urdu)" dir="rtl" required></div>
            <div class="mb-2"><input id="eventTitleEn" class="form-control" placeholder="Event Title (English)" required></div>
            <div class="mb-2"><input id="eventDate" class="form-control" placeholder="Event Date (e.g., July 20, 2026)"></div>
            <div class="mb-2"><textarea id="eventDescUr" class="form-control" placeholder="Description (Urdu)" dir="rtl" rows="3"></textarea></div>
            <div class="mb-2"><textarea id="eventDescEn" class="form-control" placeholder="Description (English)" rows="3"></textarea></div>
            <button class="btn btn-success btn-sm" type="submit">Add Event</button>
          </form>
          <div id="eventsAdminList"></div>
        `;

        document.getElementById('eventForm').addEventListener('submit', async function(e) {
          e.preventDefault();
          const submitButton = this.querySelector('button[type="submit"]');
          submitButton.disabled = true;
          submitButton.innerText = "Saving...";
          
          try {
            await addDoc(collection(db, "events"), {
              titleUr: document.getElementById('eventTitleUr').value,
              titleEn: document.getElementById('eventTitleEn').value,
              date: document.getElementById('eventDate').value,
              descUr: document.getElementById('eventDescUr').value,
              descEn: document.getElementById('eventDescEn').value,
              createdAt: new Date()
            });
            showToast('Event added!', 'success');
            loadAdminPanel('events'); // Refresh
          } catch (error) {
            showToast(error.message, 'danger');
          } finally {
            submitButton.disabled = false;
            submitButton.innerText = "Add Event";
          }
        });

        const out = document.getElementById('eventsAdminList');
        const q = query(collection(db, "events"), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
          out.innerHTML = '';
          if (snapshot.empty) out.innerHTML = '<p>No events yet.</p>';
          snapshot.forEach(snapshotDoc => {
            const e = snapshotDoc.data();
            const el = document.createElement('div');
            el.className = 'card mb-2 p-2';
            el.innerHTML = `
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <strong>${e.titleUr || e.titleEn}</strong>
                  <div class="small text-muted">${e.date || ''}</div>
                </div>
                <button class="btn btn-sm btn-danger" data-id="${snapshotDoc.id}">Delete</button>
              </div>`;
            out.appendChild(el);
            
            el.querySelector('button').addEventListener('click', async (btnEvt) => {
              const id = btnEvt.target.dataset.id;
              if (confirm('Are you sure you want to delete this event?')) {
                await deleteDoc(doc(db, "events", id));
                showToast('Event deleted', 'success');
              }
            });
          });
        });
      }

      // --- Gallery Panel (Base64) ---
      if(panel === 'gallery'){
        content.innerHTML = `
          <h5>Gallery</h5>
          <form id="galleryForm" class="mb-3">
            <div class="mb-2"><input id="galleryFile" type="file" accept="image/*" class="form-control" required></div>
            <div class="mb-2"><input id="galleryName" class="form-control" placeholder="Image name (optional)"></div>
            <button class="btn btn-success btn-sm" type="submit">Upload</button>
            <small class="d-block mt-2"><b>Note:</b> Images must be under 750KB. If using 1080x1080px images, please save as a medium-quality JPEG.</small>
          </form>
          <div id="galleryAdminList" class="d-flex flex-wrap gap-2"></div>
        `;
        
        document.getElementById('galleryForm').addEventListener('submit', async function(e){
          e.preventDefault(); 
          const file = document.getElementById('galleryFile').files[0];
          const name = document.getElementById('galleryName').value.trim();
          if(!file) { showToast('Please select a file', 'danger'); return; }
          
          const submitButton = this.querySelector('button[type="submit"]');
          submitButton.disabled = true;
          submitButton.innerText = "Uploading...";

          try {
            const base64Data = await toBase64(file);
            
            await addDoc(collection(db, "gallery"), {
              name: name || file.name,
              imageData: base64Data, // Save base64 string
              createdAt: new Date()
            });
            
            showToast('Image uploaded!', 'success');
            renderGallery();
            loadAdminPanel('gallery');
          } catch(error) {
            showToast(error.message, 'danger');
          } finally {
            submitButton.disabled = false;
            submitButton.innerText = "Upload";
          }
        });

        const out = document.getElementById('galleryAdminList');
        const gallerySnapshot = await getDocs(collection(db, "gallery"));
        if (gallerySnapshot.empty) out.innerHTML = '<p>No images yet.</p>';
        gallerySnapshot.forEach(snapshotDoc => {
          const g = snapshotDoc.data();
          const el = document.createElement('div'); el.style.width='120px';
          el.innerHTML = `<div style="width:120px"><img src="${g.imageData}" style="width:100%; height:80px; object-fit:cover; border-radius:6px"><div class="mt-1 d-flex justify-content-between"><button class="btn btn-sm btn-danger" data-id="${snapshotDoc.id}">Del</button></div></div>`;
          out.appendChild(el);
          
          el.querySelector('button').addEventListener('click', async (e)=>{
            const id = e.target.dataset.id;
            if (confirm('Are you sure you want to delete this image?')) {
              try {
                await deleteDoc(doc(db, "gallery", id));
                showToast('Image deleted', 'success');
                renderGallery();
                loadAdminPanel('gallery');
              } catch (error) { showToast(error.message, 'danger'); }
            }
          });
        });
      }

      // --- Custom Sections Panel (Base64) ---
      if (panel === 'sections') {
        content.innerHTML = `
          <h5>Custom Sections</h5>
          <form id="sectionForm" class="mb-3">
            <div class="mb-2"><input id="sectionTitleUr" class="form-control" placeholder="Section Title (Urdu)" dir="rtl" required></div>
            <div class="mb-2"><input id="sectionTitleEn" class="form-control" placeholder="Section Title (English)" required></div>
            <div class="mb-2"><textarea id="sectionTextUr" class="form-control" placeholder="Text (Urdu)" dir="rtl" rows="3"></textarea></div>
            <div class="mb-2"><textarea id="sectionTextEn" class="form-control" placeholder="Text (English)" rows="3"></textarea></div>
            <div class="mb-2"><label class="form-label">Image (Optional, Max 750KB)</label><input id="sectionFile" type="file" accept="image/*" class="form-control"></div>
            <button class="btn btn-success btn-sm" type="submit">Add Section</button>
          </form>
          <div id="sectionsAdminList"></div>
        `;

        document.getElementById('sectionForm').addEventListener('submit', async function(e) {
          e.preventDefault();
          const submitButton = this.querySelector('button[type="submit"]');
          submitButton.disabled = true;
          submitButton.innerText = "Saving...";
          
          const file = document.getElementById('sectionFile').files[0];
          let base64Data = '';

          try {
            if (file) {
              base64Data = await toBase64(file);
            }

            await addDoc(collection(db, "customSections"), {
              titleUr: document.getElementById('sectionTitleUr').value,
              titleEn: document.getElementById('sectionTitleEn').value,
              textUr: document.getElementById('sectionTextUr').value,
              textEn: document.getElementById('sectionTextEn').value,
              imageData: base64Data, // Save base64
              createdAt: new Date()
            });
            showToast('Section added!', 'success');
            loadAdminPanel('sections'); // Refresh
          } catch (error) {
            showToast(error.message, 'danger');
          } finally {
            submitButton.disabled = false;
            submitButton.innerText = "Add Section";
          }
        });

        const out = document.getElementById('sectionsAdminList');
        const q = query(collection(db, "customSections"), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
          out.innerHTML = '';
          if (snapshot.empty) out.innerHTML = '<p>No sections yet.</p>';
          snapshot.forEach(snapshotDoc => {
            const s = snapshotDoc.data();
            const el = document.createElement('div');
            el.className = 'card mb-2 p-2';
            el.innerHTML = `
              <div class="d-flex justify-content-between align-items-start">
                <strong>${s.titleUr || s.titleEn}</strong>
                <button class="btn btn-sm btn-danger" data-id="${snapshotDoc.id}">Delete</button>
              </div>`;
            out.appendChild(el);
            
            el.querySelector('button').addEventListener('click', async (btnEvt) => {
              const id = btnEvt.target.dataset.id;
              if (confirm('Are you sure you want to delete this section?')) {
                try {
                  await deleteDoc(doc(db, "customSections", id));
                  showToast('Section deleted', 'success');
                } catch (error) { showToast(error.message, 'danger'); }
              }
            });
          });
        });
      }

      // --- Logo Panel (Base64) ---
      if(panel === 'logo'){
        content.innerHTML = `
          <h5 id="adminLogoTitle">Logo</h5>
          <p>Upload a logo to replace the default initial in the navbar. (Max 750KB)</p>
          <div class="mb-3">
            <label class="form-label">Current Logo</label>
            <div id="adminLogoPreviewContainer">
              <!-- Logo will be loaded by the real-time listener -->
            </div>
          </div>
          <form id="logoForm" class="mb-3">
            <div class="mb-2"><input id="logoFile" type="file" accept="image/png, image/jpeg, image/svg+xml, image/webp" class="form-control"></div>
            <button class="btn btn-success btn-sm">Save Logo</button>
          </form>
          <button class="btn btn-outline-danger btn-sm" id="removeLogoButton">Remove Logo</button>
        `;

        const logoPreviewContainer = document.getElementById('adminLogoPreviewContainer');
        onSnapshot(doc(db, "siteConfig", "logo"), (doc) => {
          if (doc.exists() && doc.data().logoData) {
            logoPreviewContainer.innerHTML = `<img src="${doc.data().logoData}" id="adminLogoPreview" alt="Logo">`;
            document.getElementById('removeLogoButton').disabled = false;
          } else {
            logoPreviewContainer.innerHTML = `<span class="text-muted">No logo uploaded</span>`;
            document.getElementById('removeLogoButton').disabled = true;
          }
        });

        document.getElementById('logoForm').addEventListener('submit', async function(e){
          e.preventDefault();
          const f = document.getElementById('logoFile').files[0];
          if(!f) { showToast('Please select a file', 'danger'); return; }
          
          const submitButton = this.querySelector('button');
          submitButton.disabled = true;
          submitButton.innerText = "Uploading...";
          
          try {
            const base64Data = await toBase64(f);
            
            await setDoc(doc(db, "siteConfig", "logo"), {
              logoData: base64Data
            });
            showToast('Logo updated!', 'success');
          } catch(error) {
            showToast(error.message, 'danger');
          } finally {
            submitButton.disabled = false;
            submitButton.innerText = "Save Logo";
          }
        });

        document.getElementById('removeLogoButton').addEventListener('click', async function(){
          if (!confirm('Are you sure you want to remove the logo?')) return;
          try {
            await deleteDoc(doc(db, "siteConfig", "logo"));
            showToast('Logo removed', 'success');
          } catch(error) { showToast(error.message, 'danger'); }
        });
      }
      
      // --- Donation Settings Panel ---
      if(panel === 'donationSettings'){
        content.innerHTML = `
          <h5>Edit Donation Settings</h5>
          <form id="donationSettingsForm" class="mb-3">
            <div class="mb-2">
              <label class="form-label">UPI ID (e.g., 9058... @okbizaxis)</label>
              <input id="upiId" class="form-control">
            </div>
            <button class="btn btn-success btn-sm">Save Settings</button>
          </form>
        `;
        
        const docRef = doc(db, "siteConfig", "donations");
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          document.getElementById('upiId').value = docSnap.data().upiId || '';
        }

        document.getElementById('donationSettingsForm').addEventListener('submit', async function(e){
          e.preventDefault();
          const data = {
            upiId: document.getElementById('upiId').value
          };
          try {
            await setDoc(docRef, data);
            showToast('Donation settings updated!', 'success');
          } catch(error) { showToast(error.message, 'danger'); }
        });
      }

      // --- Messages Panel ---
      if(panel === 'messages'){
        content.innerHTML = `
          <h5>Messages</h5>
          <div id="msgsList"></div>
        `;
        const out = document.getElementById('msgsList');
        const msgSnapshot = await getDocs(query(collection(db, "messages"), orderBy("createdAt", "desc")));
        if (msgSnapshot.empty) {
          out.innerHTML = '<p class="text-muted">No messages yet.</p>';
        }
        msgSnapshot.forEach(doc => {
          const m = doc.data();
          const el = document.createElement('div'); el.className='card mb-2 p-2';
          el.innerHTML = `<div><strong>${m.name} — ${m.email}</strong><div class="small text-muted">${m.createdAt.toDate().toLocaleString()}</div><p>${m.message}</p></div>`;
          out.appendChild(el);
        });
      }
      
      // --- Donations Panel ---
      if(panel === 'donations'){
        content.innerHTML = `
          <h5 id="adminDonationsTitle">Donations</h5>
          <div id="donationsList"></div>
        `;
        const out = document.getElementById('donationsList');
        const donSnapshot = await getDocs(query(collection(db, "donations"), orderBy("createdAt", "desc")));
        if (donSnapshot.empty) {
          out.innerHTML = '<p class="text-muted">No donation submissions yet.</p>';
        }
        donSnapshot.forEach(doc => {
          const d = doc.data();
          const el = document.createElement('div'); el.className='card mb-2 p-2'; 
          el.innerHTML = `
            <div class="d-flex justify-content-between">
              <strong>${d.name} (₹${d.amount})</strong>
              <span class="badge bg-primary">${d.type}</span>
            </div>
            <div class="small text-muted">${d.createdAt.toDate().toLocaleString()}</div>
            <p class="mb-1 mt-2">
              <strong>Phone:</strong> ${d.phone}<br>
              <strong>Email:</strong> ${d.email}<br>
              <strong>Address:</strong> ${d.address}<br>
              <strong>Doc ID:</strong> ${d.docId}
            </p>
          `;
          out.appendChild(el);
        });
      }
    }

    // ----------------- Language switching (UPDATED) -----------------
    const langSelect = document.getElementById('langToggle')
    
    function applyLanguage(lang){
      currentLang = lang;
      const root = document.documentElement
      if(lang === 'ur'){
        root.lang = 'ur'; root.dir = 'rtl'
      } else { 
        root.lang = 'en'; root.dir = 'ltr' 
      }

      const t = i18n[lang]
      if (!t) return;
      
      const setText = (id, key) => {
        const el = document.getElementById(id);
        if (el) el.textContent = t[key];
      };

      // Navbar
      setText('brandTitle', 'brandTitle');
      setText('brandSubtitle', 'brandSubtitle');
      setText('navHome', 'navHome');
      setText('navAbout', 'navAbout');
      setText('navCourses', 'navCourses');
      setText('navEvents', 'navEvents');
      setText('navGallery', 'navGallery');
      setText('navSections', 'navSections');
      setText('navLibrary', 'navLibrary');
      setText('navDonation', 'navDonation');
      setText('navContact', 'navContact');
      setText('openAdmin', 'navAdmin');

      // Page Content (Dynamic)
      const heroTitleEl = document.getElementById('heroTitle');
      const heroSubtitleEl = document.getElementById('heroSubtitle');
      const aboutTextEl = document.getElementById('aboutText');

      if (homeData) {
        heroTitleEl.textContent = lang === 'ur' ? homeData.heroTitleUr : homeData.heroTitleEn;
        heroSubtitleEl.textContent = lang === 'ur' ? homeData.heroSubtitleUr : homeData.heroSubtitleEn;
      }
      if (aboutData) {
        aboutTextEl.textContent = lang === 'ur' ? aboutData.aboutTextUr : aboutData.aboutTextEn;
      }
      
      // Render Events
      const eventsList = document.getElementById('eventsList');
      eventsList.innerHTML = ''; // Clear
      if (eventsData.length === 0) eventsList.innerHTML = '<p>No events listed yet.</p>';
      eventsData.forEach(e => {
        const title = lang === 'ur' ? e.titleUr : e.titleEn;
        const desc = lang === 'ur' ? e.descUr : e.descEn;
        const el = document.createElement('div');
        el.className = 'col-md-6';
        el.innerHTML = `
          <div class="card h-100">
            <div class="card-body">
              <h5 class="card-title">${title}</h5>
              <h6 class="card-subtitle mb-2 text-muted">${e.date || ''}</h6>
              <p class="card-text">${desc}</p>
            </div>
          </div>
        `;
        eventsList.appendChild(el);
      });

      // Render Custom Sections
      const sectionsList = document.getElementById('customSectionsList');
      sectionsList.innerHTML = ''; // Clear
      if (sectionsData.length === 0) sectionsList.innerHTML = '<p>No sections added yet.</p>';
      sectionsData.forEach(s => {
        const title = lang === 'ur' ? s.titleUr : s.titleEn;
        const text = lang === 'ur' ? s.textUr : s.textEn;
        const el = document.createElement('div');
        el.className = 'row mb-4';
        // Logic for image left/right or no image
        if (s.imageData) {
          el.innerHTML = `
            <div class="section-title mb-3">
              <h2>${title}</h2>
            </div>
            <div class="col-lg-6">
              <p>${text}</p>
            </div>
            <div class="col-lg-6">
              <img src="${s.imageData}" alt="${title}" class="img-fluid rounded">
            </div>
          `;
        } else {
          el.innerHTML = `
            <div class="section-title mb-3">
              <h2>${title}</h2>
            </div>
            <div class="col-lg-12">
              <p>${text}</p>
            </div>
          `;
        }
        sectionsList.appendChild(el);
      });

      // Page Content (Static)
      setText('qLinkDonation', 'qLinkDonation');
      setText('qLinkFatwa', 'qLinkFatwa');
      setText('qLinkBooks', 'qLinkBooks');
      setText('qLinkGallery', 'qLinkGallery');
      setText('aboutHeading', 'aboutHeading');
      setText('coursesHeading', 'coursesHeading');
      setText('eventsHeading', 'eventsHeading');
      setText('galleryHeading', 'galleryHeading');
      
      // Library Section
      setText('libraryHeading', 'libraryHeading');
      setText('libraryCardTitle', 'libraryCardTitle');
      setText('libraryCardText', 'libraryCardText');
      setText('libraryCardButton', 'libraryCardButton');

      // Donation Section
      setText('donationHeading', 'donationHeading');
      setText('lblDonationAmount', 'lblDonationAmount');
      setText('lblDonationType', 'lblDonationType');
      setText('optDonationGeneral', 'optDonationGeneral');
      setText('optDonationZakat', 'optDonationZakat');
      setText('optDonationSadqa', 'optDonationSadqa');
      setText('optDonationConstruction', 'optDonationConstruction');
      setText('optDonationOther', 'optDonationOther');
      setText('lblOtherDonationType', 'lblOtherDonationType');
      setText('lblDonationName', 'lblDonationName');
      setText('lblDonationPhone', 'lblDonationPhone');
      setText('lblDonationAddress', 'lblDonationAddress');
      setText('lblDonationEmail', 'lblDonationEmail');
      setText('lblDonationDocId', 'lblDonationDocId');
      setText('donationSubmit', 'donationSubmit');
      setText('donationPaymentTitle', 'donationPaymentTitle');
      setText('donationPaymentSubtitle', 'donationPaymentSubtitle');
      setText('copyUpiBtnText', 'copyUpiBtnText');
      setText('payNowBtnText', 'payNowBtnText');

      // Contact
      setText('contactHeading', 'contactHeading');
      setText('lblName', 'lblName');
      setText('lblEmail', 'lblEmail');
      setText('lblSubject', 'lblSubject');
      setText('lblMessage', 'lblMessage');
      setText('contactSubmit', 'contactSubmit');
      setText('contactInfoHeading', 'contactInfoHeading');
      setText('lblAddress', 'lblAddress');
      setText('lblPhone', 'lblPhone');
      setText('lblContactEmail', 'lblContactEmail');
      setText('lblMap', 'lblMap');
      setText('linkMap', 'linkMap');
      
      const contactNote = document.getElementById('contactFormNote');
      if (contactNote) contactNote.textContent = t.contactFormNote;
      
      // Admin panel
      setText('adminNavDonations', 'adminDonations');
      const logoAdminBtn = document.querySelector('[data-panel="logo"]');
      if (logoAdminBtn) logoAdminBtn.textContent = t.adminLogo;
      setText('adminLogoTitle', 'adminLogo');
      setText('adminDonationsTitle', 'adminDonations');
    }

    langSelect.addEventListener('change', ()=> applyLanguage(langSelect.value))
    applyLanguage('ur')

    // Smooth scroll for nav links
    document.querySelectorAll('[data-link]').forEach(a=> a.addEventListener('click', function(e){ e.preventDefault(); const id = this.getAttribute('href').slice(1); document.getElementById(id).scrollIntoView({behavior:'smooth'}) }))

    // --- FIX for Modal Accessibility Warning ---
    const adminModalEl = document.getElementById('adminModal');
    const openAdminButton = document.getElementById('openAdmin');
    if (adminModalEl) {
      adminModalEl.addEventListener('hidden.bs.modal', () => {
        if (openAdminButton) {
          openAdminButton.focus();
        }
      });
    }

    // ----------------- Dark Mode Toggle (unchanged) -----------------
    const darkModeToggle = document.getElementById('darkModeToggle');
    const sunIcon = darkModeToggle.querySelector('.bi-sun-fill');
    const moonIcon = darkModeToggle.querySelector('.bi-moon-fill');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
    const currentTheme = localStorage.getItem('theme');

    function setDarkMode(isDark) {
      if (isDark) {
        document.body.classList.add('dark-mode');
        sunIcon.style.display = 'inline-block';
        moonIcon.style.display = 'none';
        localStorage.setItem('theme', 'dark');
      } else {
        document.body.classList.remove('dark-mode');
        sunIcon.style.display = 'none';
        moonIcon.style.display = 'inline-block';
        localStorage.setItem('theme', 'light');
      }
    }

    if (currentTheme === 'dark') {
      setDarkMode(true);
    } else if (currentTheme === 'light') {
      setDarkMode(false);
    } else {
      setDarkMode(prefersDark.matches);
    }

    darkModeToggle.addEventListener('click', () => {
      setDarkMode(!document.body.classList.contains('dark-mode'));
    });

    prefersDark.addEventListener('change', (e) => {
      if (!localStorage.getItem('theme')) {
        setDarkMode(e.matches);
      }
    });

    // ----------------- Donation Modal Logic (UPDATED) -----------------
    let upiId = '9058438854-2@okbizaxis'; // Default fallback
    let upiLink = '';
    let qrUrl = '';

    function updateDonationLinks(newUpiId) {
      upiId = newUpiId;
      upiLink = `upi://pay?pa=${upiId}&pn=Darut%20Taleem%20Wat%20Tarbiyah&am=&cu=INR&tn=Donation`;
      qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(upiLink)}`;
      
      document.getElementById('donationQR').src = qrUrl;
      document.getElementById('payNowLink').href = upiLink;
      document.getElementById('upiIdInput').value = upiId;
    }

    function renderDonationSettings() {
      onSnapshot(doc(db, "siteConfig", "donations"), (doc) => {
        let newUpiId = '9058438854-2@okbizaxis'; // Default
        if (doc.exists() && doc.data().upiId) {
          newUpiId = doc.data().upiId;
        }
        updateDonationLinks(newUpiId);
      }, (error) => {
        console.error("Error fetching donation settings: ", error);
        updateDonationLinks(upiId); // Use default if error
      });
    }
    renderDonationSettings();

    document.getElementById('copyUpiButton').addEventListener('click', function() {
      const upiInput = document.getElementById('upiIdInput');
      try {
        upiInput.select();
        upiInput.setSelectionRange(0, 99999);
        document.execCommand('copy');
        
        const lang = document.getElementById('langToggle').value;
        showToast(i18n[lang].copiedToast, 'success');

      } catch (err) {
        console.error('Failed to copy UPI ID: ', err);
        showToast('Failed to copy', 'danger');
      }
    });

  </script>
</body>
</html>
